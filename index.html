<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™ ğŸ³ï¸â€ğŸŒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #F3F4F6; color: #1F2937; -webkit-tap-highlight-color: transparent; }
        
        /* Mode Visibility */
        body:not(.editing) .edit-only { display: none !important; }
        body.editing .view-only { display: none !important; }
        body.editing .editable-container { border: 1px dashed #9CA3AF; padding: 4px; border-radius: 4px; background: rgba(255,255,255,0.5); }

        /* Custom Inputs */
        input, textarea, select { background: transparent; border-bottom: 1px solid #D1D5DB; outline: none; transition: border 0.3s; width: 100%; }
        body.editing input:focus, body.editing textarea:focus { border-bottom: 2px solid #4F46E5; background: #fff; }

        /* Timeline */
        .timeline-row { position: relative; padding-right: 20px; border-right: 2px solid #E5E7EB; padding-bottom: 20px; }
        .timeline-row:last-child { border-right: none; }
        .timeline-dot { position: absolute; right: -6px; top: 0; width: 10px; height: 10px; background: #4F46E5; border-radius: 50%; border: 2px solid white; }
        
        /* Badges */
        .badge-booked { background-color: #DCFCE7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; border: 1px solid #86EFAC; }
        .badge-pending { background-color: #F3F4F6; color: #6B7280; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #D1D5DB; }

        /* Option Cards */
        .option-card { border: 1px solid #E5E7EB; padding: 10px; border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; background: white; position: relative; }
        .option-card.selected { border: 2px solid #4F46E5; background: #EEF2FF; }
        .option-card:not(.selected) { opacity: 0.7; }
        .option-card:not(.selected):hover { opacity: 1; border-color: #A5B4FC; cursor: pointer; }

        /* Sticky Notes */
        .note-trigger { color: #F59E0B; cursor: pointer; transition: transform 0.2s; }
        .note-trigger:hover { transform: scale(1.2); }
        .sticky-note-card {
            display: none; 
            background-color: #FEF3C7; color: #4D453E; padding: 10px; border-radius: 8px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15); font-family: 'Kalam', cursive; margin-top: 8px;
            border: 1px solid #FCD34D; animation: fadeIn 0.2s; position: relative;
        }
        .sticky-note-card.visible { display: block; }

        /* Tabs */
        .tab-btn.active { color: #4F46E5; border-bottom: 2px solid #4F46E5; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Loading */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <!-- Loading & Login -->
    <div id="loading-screen"><div class="loader mb-4"></div><p class="text-gray-600 font-bold">×˜×•×¢×Ÿ ××ª ×”×˜×™×•×œ...</p></div>
    
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-80">
            <div class="text-4xl mb-4">ğŸ‘¬</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™</h2>
            <input type="password" id="passcode-input" placeholder="×”×–×Ÿ ×§×•×“" class="w-full text-center text-2xl p-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-indigo-500">
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow hover:bg-indigo-700 transition">×›× ×™×¡×”</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">×§×•×“ ×©×’×•×™</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ‡³ğŸ‡´</span>
                    <h1 class="text-lg font-bold text-gray-800 leading-tight">×˜×¨×•××¡×• 2026<br><span class="text-xs text-gray-500 font-normal">×¢×¤×¨×™ & ×¢××™</span></h1>
                </div>
                
                <div class="flex gap-2">
                    <button id="currency-btn" class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-bold border border-gray-200 shadow-sm" onclick="toggleCurrency()">
                        â‚ª <span class="text-gray-400 mx-1">|</span> â‚¬
                    </button>
                    <button id="edit-btn" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-sm font-bold border border-indigo-200" onclick="toggleEditMode()">
                        âœï¸ ×¢×¨×™×›×”
                    </button>
                </div>
            </div>

            <nav class="flex overflow-x-auto gap-6 text-sm font-medium text-gray-500 no-scrollbar pb-1 border-b border-gray-100">
                <button class="tab-btn active whitespace-nowrap pb-2" onclick="switchTab('itinerary')">ğŸ“… ×œ×•×— ××¡×¢</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('logistics')">âœˆï¸ ×œ×•×’×™×¡×˜×™×§×”</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('checklist')">ğŸ’ ×¦×™×•×“</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('budget')">ğŸ’° ×ª×§×¦×™×‘</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4">

        <!-- TAB 1: ITINERARY -->
        <section id="itinerary" class="tab-content active">
            <div id="days-container" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
            <button class="edit-only w-full py-3 mt-4 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl font-bold hover:bg-white hover:border-indigo-300" onclick="addDay()">+ ×”×•×¡×£ ×™×•× ×—×“×©</button>
        </section>

        <!-- TAB 2: LOGISTICS -->
        <section id="logistics" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-800">âœˆï¸ ×˜×™×¡×•×ª (××•×¤×¦×™×•×ª)</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('flights')">+ ×”×•×¡×£</button>
                </div>
                <div id="flights-container" class="space-y-4"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ  ×œ×™× ×”</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('housing')">+ ×”×•×¡×£</button>
                </div>
                <div id="housing-container" class="space-y-4"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-800">ğŸš— ×¨×›×‘ ×©×›×•×¨</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('cars')">+ ×”×•×¡×£</button>
                </div>
                <div id="cars-container" class="space-y-4"></div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ›’ ×¡×•×¤×¨××¨×§×˜×™× ×•××•×›×œ</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('markets')">+ ×”×•×¡×£</button>
                </div>
                <div id="markets-container" class="space-y-4"></div>
            </div>
        </section>

        <!-- TAB 3: CHECKLIST -->
        <section id="checklist" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800">×¨×©×™××ª ×¦×™×•×“ ×—×•×¨×£ (××”××œ×¦×•×ª ×œ××˜×™×™×œ)</h2>
                <div class="flex gap-2 mb-4 edit-only">
                    <input type="text" id="new-item-text" placeholder="×¤×¨×™×˜..." class="border rounded px-2 py-1 text-sm">
                    <input type="text" id="new-item-source" placeholder="××§×•×¨/×—× ×•×ª" class="border rounded px-2 py-1 text-sm">
                    <input type="number" id="new-item-price" placeholder="××—×™×¨" class="border rounded px-2 py-1 text-sm w-20">
                    <button onclick="addCheckItem()" class="bg-indigo-600 text-white px-3 rounded font-bold">+</button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-2 py-2 text-right">V</th>
                                <th class="px-2 py-2 text-right">×¤×¨×™×˜</th>
                                <th class="px-2 py-2 text-right">××§×•×¨</th>
                                <th class="px-2 py-2 text-right">×¢×œ×•×ª</th>
                                <th class="px-2 py-2 edit-only"></th>
                            </tr>
                        </thead>
                        <tbody id="checklist-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TAB 4: BUDGET -->
        <section id="budget" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <h2 class="text-xl font-bold mb-6 text-gray-800">×¡×™×›×•× ×ª×§×¦×™×‘</h2>
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="h-64 w-full flex justify-center">
                        <canvas id="budgetChart"></canvas>
                    </div>
                    <div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100 mb-3">
                            <span class="block text-sm text-green-600 font-bold">×©×•×œ× / ×”×•×–××Ÿ âœ…</span>
                            <span id="total-paid" class="text-2xl font-bold text-green-700">0</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-3">
                            <span class="block text-sm text-gray-500 font-bold">× ×•×ª×¨ ×œ×©×œ× ğŸ•’</span>
                            <span id="total-future" class="text-2xl font-bold text-gray-700">0</span>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <span class="block text-sm text-gray-400">×¡×”"×› ×›×œ×œ×™</span>
                            <span id="total-sum" class="text-3xl font-bold text-indigo-600">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="sync-indicator" class="fixed bottom-4 left-4 bg-white shadow px-3 py-1 rounded-full text-xs font-bold text-gray-400 z-50 flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-gray-400" id="sync-dot"></div>
        <span id="sync-text">×××ª×™×Ÿ...</span>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBN9quYq8q01fOgDKliJ_IUq40F0askb_w", authDomain: "tromso-trip.firebaseapp.com", projectId: "tromso-trip", storageBucket: "tromso-trip.firebasestorage.app", messagingSenderId: "706076555674", appId: "1:706076555674:web:c7f3075199b975897fe223", measurementId: "G-976T7D2Q1Z" };

        let app, db, tripRef;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); tripRef = doc(db, "trips", "ofri_ami_final_v5"); } catch (e) { console.error(e); }

        // --- DATA ---
        let appData = {
            currency: 'ILS',
            days: [
                { id: 1, date: '13/1 (×’\')', title: '× ×—×™×ª×” ×•×”×ª××¨×’× ×•×ª', timeline: [
                    { time: '14:00', title: '×˜×™×¡×” ×œ-TOS', desc: 'SAS ×“×¨×š ××•×¡×œ×•', cost: 0, booked: true, info: 'PNR: SK123', note: '×œ××¡×•×£ ××–×•×•×“×•×ª ×‘××•×¡×œ×• ×•×œ×¢×©×•×ª ×¦×§ ××™×Ÿ ××—×“×©' },
                    { time: '18:00', title: '××™×¡×•×£ ×¨×›×‘', desc: 'Hertz ×‘×©×“×”', cost: 0, booked: true, info: '×©×•×‘×¨ #555', note: '×œ×‘×“×•×§ ×¦××™×’×™ ×—×•×¨×£' },
                    { time: '19:30', title: '×¡×•×¤×¨ REMA 1000', desc: '×§× ×™×•×ª ×œ×™×•××™×™× ×¨××©×•× ×™×', cost: 600, booked: false, info: '', note: '×œ×§× ×•×ª ××™× ×œ×“×¨×š' }
                ]},
                { id: 2, date: '14/1 (×“\')', title: '×”×¢×™×¨ ×˜×¨×•××¡×•', timeline: [
                    { time: '10:00', title: '×—× ×™×” ×‘××¨×›×–', desc: '×‘×ª×•×š ×”×× ×”×¨×”', cost: 120, booked: false, info: '', note: '××¤×œ×™×§×¦×™×™×ª EasyPark' },
                    { time: '11:30', title: '×¨×›×‘×œ Fjellheisen', desc: '×ª×¦×¤×™×ª ×¢×œ ×”×¢×™×¨', cost: 260, booked: false, info: '', note: '××•××œ×¥ ×œ×¢×œ×•×ª ×‘××•×¨ ×“××“×•××™×' },
                    { time: '14:00', title: 'Rakettkiosken', desc: '×”× ×§× ×™×§×™×™×” ×‘×›×™×›×¨', cost: 80, booked: false, info: '', note: '×˜×¢×™× ×•×–×•×œ' },
                    { time: '20:00', title: '×¦×™×“ ×–×•×”×¨', desc: '×¢×¦×××™ ×œ-Ersfjordbotn', cost: 0, booked: false, info: '', note: '×œ×”×‘×™× ×—×¦×•×‘×”!' }
                ]},
                { id: 3, date: '15/1 (×”\')', title: '×›×œ×‘×™× ×•×¡××•× ×”', timeline: [
                    { time: '09:00', title: '××–×—×œ×•×ª ×›×œ×‘×™×', desc: 'Villmarkssenter', cost: 1800, booked: false, info: '', note: '×œ×”×–××™×Ÿ ×—×•×“×©×™×™× ××¨××©' },
                    { time: '17:00', title: '×¡××•× ×ª Pust', desc: '×¡××•× ×” ×¦×¤×” ×‘× ××œ', cost: 400, booked: false, info: '', note: '×œ×”×‘×™× ×‘×’×“ ×™× ×•××’×‘×ª' }
                ]},
                { id: 4, date: '16/1 (×•\')', title: '×”××¢×‘×•×¨×ª ×œ×¡× ×™×”', timeline: [
                    { time: '09:30', title: '× ×¡×™×¢×” ×œ××¢×‘×•×¨×ª', desc: 'Brensholmen', cost: 0, booked: false, info: '', note: '×œ×‘×“×•×§ ×‘××¤×œ×™×§×¦×™×” ×× ×¤×¢×™×œ' },
                    { time: '13:00', title: 'Tungeneset', desc: '×ª×¦×¤×™×ª ×©×™× ×™ ×”×©×˜×Ÿ', cost: 0, booked: false, info: '', note: '××•××œ×¥ ×œ×¦×™×œ×•×' }
                ]},
                { id: 5, date: '17/1 (×©\')', title: '×”××™ ×¡× ×™×”', timeline: [
                    { time: '10:00', title: 'Bergsbotn', desc: '×”××¨×¤×¡×ª ×”×ª×œ×•×™×”', cost: 0, booked: false, info: '', note: '' },
                    { time: '20:00', title: '×–×•×”×¨ ×‘×—×•×©×š', desc: '××¤×¡ ×–×™×”×•× ××•×¨', cost: 0, booked: false, info: '', note: '' }
                ]},
                { id: 6, date: '18/1 (×\')', title: '×—×–×¨×” ×œ×˜×¨×•××¡×•', timeline: [
                    { time: '10:00', title: '× ×¡×™×¢×” ×—×–×¨×”', desc: '×“×¨×š ×”×™×‘×©×”/××¢×‘×•×¨×ª', cost: 0, booked: false, info: '', note: '' },
                    { time: '14:00', title: 'SommarÃ¸y', desc: '××™ ×”×§×™×¥', cost: 0, booked: false, info: '', note: '×—×•×¤×™× ×œ×‘× ×™× ×•××™ ×˜×•×¨×§×™×–' }
                ]},
                { id: 7, date: '19/1 (×‘\')', title: '×¤×¨×™×“×”', timeline: [
                    { time: '13:00', title: 'Polaria', desc: '××§×•×•×¨×™×•× ××¨×§×˜×™', cost: 300, booked: false, info: '', note: '' },
                    { time: '19:00', title: '××¨×•×—×ª ×¢×¨×‘', desc: 'Fiskekompaniet', cost: 600, booked: false, info: '', note: '×œ×”×–××™×Ÿ ×©×•×œ×—×Ÿ' }
                ]},
                { id: 8, date: '20/1 (×’\')', title: '×˜×™×¡×” ×œ-AMS', timeline: [
                    { time: '10:00', title: '×”×—×–×¨×ª ×¨×›×‘', desc: '×‘×©×“×”', cost: 0, booked: false, info: '', note: '' },
                    { time: '18:00', title: '××œ×•×Ÿ ×‘×©×“×”', desc: 'CitizenM', cost: 900, booked: true, info: '', note: '' }
                ]}
            ],
            logistics: {
                flights: [
                    { id: 'f1', title: '×˜×™×¡×•×ª (×œ×¤×™ ×œ××˜×™×™×œ)', options: [
                        { id: 'o1', name: 'SAS + Norwegian', desc: '×”×œ×•×š ×‘-13/1, ×—×–×•×¨ ×‘-20/1', cost: 3500, booked: true, info: '×”×•×–××Ÿ' }
                    ], selectedId: 'o1' }
                ],
                housing: [
                    { id: 'h1', title: '×˜×¨×•××¡×• (×œ×™×œ×•×ª 1-3)', date:'2026-01-13', options: [
                        { id: 'opt1', name: 'Airbnb Ersfjord', desc: '××•××œ×¥ ×œ×–×•×”×¨', cost: 3200, booked: true, info: '' },
                        { id: 'opt2', name: 'Clarion The Edge', desc: '×‘××¨×›×–', cost: 4000, booked: false, info: '' }
                    ], selectedId: 'opt1' },
                    { id: 'h2', title: '×¡× ×™×” (×œ×™×œ×•×ª 4-5)', date:'2026-01-16', options: [
                        { id: 'opt1', name: 'Mefjord Brygge', desc: '×“×™×¨×” ×‘×¤×™×•×¨×“', cost: 2400, booked: false, info: '' }
                    ], selectedId: 'opt1' }
                ],
                cars: [
                    { id: 'c1', title: '×¨×›×‘', options: [
                        { id: 'o1', name: 'Hertz (×©×“×”)', desc: 'Toyota RAV4', cost: 4500, booked: false, info: '' },
                        { id: 'o2', name: 'Rent-A-Wreck', desc: '××©×•××© ×•×–×•×œ', cost: 2800, booked: false, info: '×¦×¨×™×š ××•× ×™×ª ×œ×¡× ×™×£' }
                    ], selectedId: 'o1' }
                ],
                markets: [
                    { id: 'm1', title: '×¡×•×¤×¨××¨×§×˜ ×¨××©×™', options: [{id:'o1', name:'REMA 1000', desc:'×”×›×™ ×–×•×œ', cost:800, booked:false}], selectedId:'o1' }
                ]
            },
            checklist: [
                { id: 1, text: '×‘×™×’×•×“ ×ª×¨××™ (××¨×™× ×•)', source: '×“×§×˜×œ×•×Ÿ', cost: 400, gotIt: true },
                { id: 2, text: '×§×¨××¤×•× ×™× (×“×•×§×¨× ×™×)', source: '×××–×•×Ÿ', cost: 100, gotIt: false },
                { id: 3, text: '×©×§×™×•×ª ×—×™××•×', source: '×¨×™×§×•×©×˜', cost: 50, gotIt: false }
            ]
        };

        let isEditMode = false;
        let currentCurrency = 'ILS';
        const EUR_RATE = 4;
        const CACHE_KEY = 'tromso_v5_cache';

        // --- HELPERS ---
        const formatPrice = (ils) => currentCurrency === 'ILS' ? `â‚ª${parseInt(ils||0).toLocaleString()}` : `â‚¬${(parseInt(ils||0)/EUR_RATE).toFixed(0)}`;
        
        // --- STATE ---
        window.toggleEditMode = () => {
            isEditMode = !isEditMode;
            document.body.classList.toggle('editing', isEditMode);
            document.getElementById('edit-btn').innerHTML = isEditMode ? 'âœ… ×¡×™×•×' : 'âœï¸ ×¢×¨×™×›×”';
            document.getElementById('edit-btn').classList.toggle('bg-green-100', isEditMode);
            renderAll();
        };

        window.toggleCurrency = () => {
            currentCurrency = currentCurrency === 'ILS' ? 'EUR' : 'ILS';
            document.getElementById('currency-btn').innerHTML = currentCurrency === 'ILS' ? '<b>â‚ª</b> | â‚¬' : 'â‚ª | <b>â‚¬</b>';
            renderAll();
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        window.toggleNote = (id) => {
            const el = document.getElementById(`note-${id}`);
            if(el) el.classList.toggle('visible');
        };

        // --- RENDERERS ---
        
        // 1. Itinerary
        function renderItinerary() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            appData.days.forEach((day, dayIdx) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4';
                
                let dailyTotal = 0;
                
                const timelineHtml = day.timeline.map((item, itemIdx) => {
                    dailyTotal += parseInt(item.cost || 0);
                    const bookedHtml = item.booked ? 
                        `<span class="badge-booked" title="${item.info}">âœ”ï¸ ×”×•×–××Ÿ</span>` : 
                        `<span class="badge-pending hidden">×˜×¨×</span>`;
                    
                    const editControls = `
                        <div class="edit-only mt-2 bg-gray-50 p-2 rounded border border-dashed border-gray-300">
                            <div class="flex gap-2 mb-1">
                                <input type="time" value="${item.time}" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'time', this.value)" class="w-20">
                                <input type="text" value="${item.title}" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'title', this.value)" class="font-bold">
                            </div>
                            <input type="text" value="${item.desc}" placeholder="×ª×™××•×¨" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'desc', this.value)" class="text-xs mb-1">
                            <div class="flex gap-2 items-center mb-1">
                                <input type="number" value="${item.cost}" placeholder="××—×™×¨" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'cost', this.value)" class="w-20 text-xs">
                                <label class="text-xs flex items-center"><input type="checkbox" ${item.booked ? 'checked' : ''} onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'booked', this.checked)"> ×”×•×–××Ÿ</label>
                            </div>
                            <input type="text" value="${item.info}" placeholder="×¤×¨×˜×™ ×”×–×× ×”" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'info', this.value)" class="text-xs w-full border rounded px-1 mb-1">
                            <button onclick="deleteTimelineItem(${dayIdx}, ${itemIdx})" class="text-red-500 text-xs">××—×§</button>
                        </div>
                    `;

                    const noteHtml = `
                        <div class="mt-1 relative">
                            <i class="fa-regular fa-note-sticky note-trigger text-xs" onclick="toggleNote('t-${dayIdx}-${itemIdx}')"></i>
                            <div id="note-t-${dayIdx}-${itemIdx}" class="sticky-note-card ${item.note?'':'hidden'}">
                                <textarea class="bg-transparent w-full text-xs resize-none" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'note', this.value)" ${!isEditMode ? 'readonly' : ''}>${item.note||''}</textarea>
                            </div>
                        </div>
                    `;

                    return `
                        <div class="timeline-row pb-4">
                            <div class="timeline-dot"></div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold text-indigo-900">${item.time}</span>
                                    <span class="font-bold mr-2 view-only">${item.title}</span>
                                    <div class="text-sm text-gray-600 view-only">${item.desc}</div>
                                    <div class="mt-1 flex gap-2 items-center view-only">
                                        ${bookedHtml}
                                        ${item.cost > 0 ? `<span class="text-xs bg-gray-100 px-2 rounded font-bold">${formatPrice(item.cost)}</span>` : ''}
                                    </div>
                                    ${noteHtml}
                                </div>
                            </div>
                            ${editControls}
                        </div>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <input class="font-bold text-lg text-gray-800 bg-transparent edit-only" value="${day.title}" onchange="updateDay(${dayIdx}, 'title', this.value)">
                            <h3 class="font-bold text-lg text-gray-800 view-only">${day.title}</h3>
                            <div class="text-xs text-gray-500">${day.date}</div>
                        </div>
                        <div class="text-right">
                            <span class="block text-xs text-gray-400">×™×•××™</span>
                            <span class="font-bold text-indigo-600">${formatPrice(dailyTotal)}</span>
                        </div>
                        <button class="edit-only text-red-400" onclick="deleteDay(${dayIdx})">ğŸ—‘ï¸</button>
                    </div>
                    <div class="pl-2">${timelineHtml}</div>
                    <button class="edit-only w-full mt-2 text-xs border border-dashed border-gray-300 p-1 rounded text-gray-400" onclick="addTimelineItem(${dayIdx})">+ ×¤×¢×™×œ×•×ª</button>
                `;
                container.appendChild(card);
            });
        }

        // 2. Logistics (Generic Group Renderer with A/B Options)
        function renderLogisticsGroup(type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const groups = appData.logistics[type] || [];

            // Sort housing by date if applicable
            if(type === 'housing' || type === 'markets') groups.sort((a,b) => (a.date || '').localeCompare(b.date || ''));

            groups.forEach((group, gIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-white border border-gray-200 rounded-xl p-4 mb-4';
                
                // Header
                let header = `
                    <div class="flex justify-between mb-2">
                        <div class="w-full">
                            <input class="font-bold text-lg bg-transparent edit-only w-full" value="${group.title}" onchange="updateGroup('${type}', ${gIdx}, 'title', this.value)">
                            <h3 class="font-bold text-lg view-only flex items-center gap-2">
                                ${group.title} 
                                ${group.date ? `<span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 rounded">${group.date}</span>` : ''}
                            </h3>
                            ${isEditMode ? `<input type="date" value="${group.date || ''}" class="text-xs w-32 mb-2" onchange="updateGroup('${type}', ${gIdx}, 'date', this.value)">` : ''}
                        </div>
                        <button class="edit-only text-red-400" onclick="deleteGroup('${type}', ${gIdx})">ğŸ—‘ï¸</button>
                    </div>
                `;

                let optionsHtml = '';
                group.options.forEach((opt, oIdx) => {
                    const isSelected = group.selectedId === opt.id;
                    const bookedHtml = opt.booked ? `<span class="badge-booked">×”×•×–××Ÿ</span>` : '';
                    
                    // Note Logic
                    const noteId = `${type}-${gIdx}-${oIdx}`;
                    const noteHtml = `
                        <div class="mt-1">
                            <i class="fa-regular fa-note-sticky note-trigger text-xs" onclick="toggleNote('${noteId}')"></i>
                            <div id="note-${noteId}" class="sticky-note-card ${opt.note?'':'hidden'}">
                                <textarea class="bg-transparent w-full text-xs resize-none" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'note', this.value)" ${!isEditMode ? 'readonly' : ''}>${opt.note||''}</textarea>
                            </div>
                        </div>
                    `;

                    if (isEditMode) {
                        optionsHtml += `
                            <div class="option-card ${isSelected ? 'selected' : ''} p-3 relative mb-2">
                                <div class="absolute top-2 left-2 flex gap-2">
                                    <input type="radio" name="grp-${type}-${gIdx}" ${isSelected ? 'checked' : ''} onchange="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                    <button class="text-red-400 text-xs" onclick="deleteOption('${type}', ${gIdx}, ${oIdx})">x</button>
                                </div>
                                <input class="font-bold text-sm mb-1" value="${opt.name}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'name', this.value)">
                                <textarea class="text-xs mb-1" rows="2" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'desc', this.value)">${opt.desc}</textarea>
                                <div class="flex gap-2 mb-1">
                                    <input type="number" class="w-20 text-xs" value="${opt.cost}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'cost', this.value)">
                                </div>
                                <div class="flex gap-2 items-center bg-gray-50 p-1 rounded">
                                    <label class="text-xs flex items-center gap-1"><input type="checkbox" ${opt.booked ? 'checked' : ''} onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'booked', this.checked)"> ×”×•×–××Ÿ</label>
                                    <input class="text-xs flex-1" placeholder="×¤×¨×˜×™ ×”×–×× ×”" value="${opt.info || ''}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'info', this.value)">
                                </div>
                                ${noteHtml}
                            </div>
                        `;
                    } else {
                        // View Mode
                        optionsHtml += `
                            <div class="option-card ${isSelected ? 'selected' : ''} flex justify-between items-center p-3 mb-2 cursor-pointer hover:bg-gray-50" onclick="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                <div>
                                    <div class="font-bold text-sm flex items-center gap-2">
                                        ${opt.name} 
                                        ${bookedHtml}
                                        ${isSelected ? '<span class="text-indigo-600 text-xs border border-indigo-200 px-1 rounded">× ×‘×—×¨</span>' : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">${opt.desc}</div>
                                    ${opt.booked && opt.info ? `<div class="text-xs bg-green-50 text-green-800 p-1 mt-1 rounded">${opt.info}</div>` : ''}
                                    ${noteHtml}
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-indigo-700">${formatPrice(opt.cost)}</div>
                                </div>
                            </div>
                        `;
                    }
                });

                wrapper.innerHTML = header + optionsHtml + (isEditMode ? `<button class="w-full text-xs border border-dashed p-1 mt-1 text-gray-400" onclick="addOption('${type}', ${gIdx})">+ ××•×¤×¦×™×”</button>` : '');
                container.appendChild(wrapper);
            });
        }

        // 3. Checklist Renderer
        function renderChecklist() {
            const tbody = document.getElementById('checklist-table-body');
            tbody.innerHTML = '';
            
            appData.checklist.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                
                // Note Logic
                const noteHtml = `
                    <div class="relative inline-block">
                        <i class="fa-regular fa-note-sticky note-trigger text-xs ml-2" onclick="toggleNote('c-${idx}')"></i>
                        <div id="note-c-${idx}" class="sticky-note-card absolute z-10 right-0 w-40 ${item.note?'':'hidden'}">
                            <textarea class="bg-transparent w-full text-xs resize-none h-16" onchange="updateChecklist(${idx}, 'note', this.value)" ${!isEditMode ? 'readonly' : ''}>${item.note||''}</textarea>
                        </div>
                    </div>
                `;

                tr.innerHTML = `
                    <td class="px-2 py-3"><input type="checkbox" class="w-5 h-5 accent-indigo-600 cursor-pointer" ${item.gotIt ? 'checked' : ''} onchange="updateChecklist(${idx}, 'gotIt', this.checked)"></td>
                    <td class="px-2 py-3">
                        <span class="view-only ${item.gotIt ? 'line-through text-gray-400' : ''}">${item.text}</span>
                        <input class="edit-only" value="${item.text}" onchange="updateChecklist(${idx}, 'text', this.value)">
                        ${noteHtml}
                    </td>
                    <td class="px-2 py-3 text-xs"><span class="view-only">${item.source || '-'}</span><input class="edit-only" value="${item.source || ''}" placeholder="××§×•×¨" onchange="updateChecklist(${idx}, 'source', this.value)"></td>
                    <td class="px-2 py-3 font-bold text-indigo-600"><span class="view-only">${formatPrice(item.cost)}</span><input type="number" class="edit-only w-20" value="${item.cost}" onchange="updateChecklist(${idx}, 'cost', this.value)"></td>
                    <td class="px-2 py-3 edit-only"><button class="text-red-400" onclick="deleteChecklist(${idx})">ğŸ—‘ï¸</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. Budget Renderer
        function renderBudget() {
            let paid = 0, future = 0;
            
            const sum = (c, b) => b ? paid += parseInt(c||0) : future += parseInt(c||0);

            appData.days.forEach(d => d.timeline.forEach(t => sum(t.cost, t.booked)));
            ['flights','housing','cars','markets'].forEach(t => (appData.logistics[t]||[]).forEach(g => {
                const s = g.options.find(o => o.id === g.selectedId);
                if(s) sum(s.cost, s.booked);
            }));
            appData.checklist.forEach(c => sum(c.cost, c.gotIt));

            document.getElementById('total-paid').textContent = formatPrice(paid);
            document.getElementById('total-future').textContent = formatPrice(future);
            document.getElementById('total-sum').textContent = formatPrice(paid+future);

            const ctx = document.getElementById('budgetChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['×©×•×œ×','×¢×ª×™×“×™'],
                    datasets: [{ data: [paid, future], backgroundColor: ['#4ade80', '#e5e7eb'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- ACTIONS ---
        
        // Actions wrappers
        window.addDay = () => { appData.days.push({id:Date.now(), date:'×ª××¨×™×š', title:'×—×“×©', timeline:[]}); saveData(); renderAll(); }
        window.deleteDay = (idx) => { if(confirm('?')) { appData.days.splice(idx,1); saveData(); renderAll(); } }
        window.updateDay = (idx, field, val) => { appData.days[idx][field]=val; saveData(); renderAll(); }
        
        window.addTimelineItem = (dIdx) => { appData.days[dIdx].timeline.push({time:'12:00', title:'×¤×¢×™×œ×•×ª', desc:'', cost:0, booked:false}); saveData(); renderAll(); }
        window.deleteTimelineItem = (dIdx, tIdx) => { appData.days[dIdx].timeline.splice(tIdx, 1); saveData(); renderAll(); }
        window.updateTimeline = (dIdx, tIdx, field, val) => { appData.days[dIdx].timeline[tIdx][field]=val; saveData(); renderAll(); }

        window.addGroup = (t) => { if(!appData.logistics[t]) appData.logistics[t]=[]; appData.logistics[t].push({id:Date.now(), title:'×—×“×©', options:[{id:'o'+Date.now(), name:'××•×¤×¦×™×” 1', cost:0}], selectedId:'o'+Date.now()}); saveData(); renderAll(); }
        window.deleteGroup = (t, i) => { if(confirm('?')) { appData.logistics[t].splice(i,1); saveData(); renderAll(); } }
        window.updateGroup = (t, i, f, v) => { appData.logistics[t][i][f]=v; saveData(); renderAll(); }
        
        window.addOption = (t, g) => { appData.logistics[t][g].options.push({id:'o'+Date.now(), name:'×—×“×©', cost:0}); saveData(); renderAll(); }
        window.deleteOption = (t, g, o) => { appData.logistics[t][g].options.splice(o,1); saveData(); renderAll(); }
        window.updateOption = (t, g, o, f, v) => { appData.logistics[t][g].options[o][f]=v; saveData(); renderAll(); }
        window.selectOption = (t, g, id) => { appData.logistics[t][g].selectedId=id; saveData(); renderAll(); }

        window.addCheckItem = () => { appData.checklist.push({id:Date.now(), text: document.getElementById('new-item-text').value, source: document.getElementById('new-item-source').value, cost: document.getElementById('new-item-price').value, gotIt: false}); saveData(); renderAll(); }
        window.updateChecklist = (i,f,v) => { appData.checklist[i][f]=v; saveData(); renderAll(); }
        window.deleteChecklist = (i) => { appData.checklist.splice(i,1); saveData(); renderAll(); }

        // --- CORE ---
        async function saveData() {
            updateSyncStatus('×©×•××¨...', 'yellow');
            try { 
                await updateDoc(tripRef, appData); 
                localStorage.setItem(CACHE_KEY, JSON.stringify(appData));
                updateSyncStatus('××¡×•× ×›×¨×Ÿ', 'green');
            } catch(e) { console.error(e); }
        }

        function updateSyncStatus(t, c) {
            document.getElementById('sync-text').textContent = t;
            document.getElementById('sync-dot').className = `w-2 h-2 rounded-full bg-${c}-500`;
        }

        window.renderAll = () => {
            renderItinerary();
            renderLogisticsGroup('flights', 'flights-container');
            renderLogisticsGroup('housing', 'housing-container');
            renderLogisticsGroup('cars', 'cars-container');
            renderLogisticsGroup('markets', 'markets-container');
            renderChecklist();
            renderBudget();
        }

        // --- INIT ---
        const CORRECT_CODE = '8989';
        
        // Cache Check
        if (localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            const cached = localStorage.getItem(CACHE_KEY);
            if(cached) { appData = JSON.parse(cached); renderAll(); }
            
            onSnapshot(tripRef, (s) => {
                document.getElementById('loading-screen').style.display = 'none';
                if(s.exists()) { 
                    appData = s.data(); 
                    if(!appData.logistics) appData.logistics = {flights:[],housing:[],cars:[],markets:[]};
                    localStorage.setItem(CACHE_KEY, JSON.stringify(appData)); 
                    renderAll(); 
                    updateSyncStatus('××¡×•× ×›×¨×Ÿ', 'green');
                } else { setDoc(tripRef, appData); }
            });
        } else {
            document.getElementById('loading-screen').style.display = 'none';
        }

        document.getElementById('login-btn').onclick = () => {
            if(document.getElementById('passcode-input').value === CORRECT_CODE) {
                localStorage.setItem('isLoggedIn', 'true');
                // No reload, just hide
                document.getElementById('login-screen').style.display = 'none';
                onSnapshot(tripRef, (s) => {
                    if(s.exists()) appData = s.data();
                    renderAll();
                });
            } else document.getElementById('login-error').classList.remove('hidden');
        };

    </script>
</body>
</html>
