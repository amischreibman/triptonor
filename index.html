<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™ ğŸ³ï¸â€ğŸŒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #F5F0E6; color: #4D453E; -webkit-tap-highlight-color: transparent; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        /* View vs Edit Mode Visibility */
        body:not(.editing) .edit-only { display: none !important; }
        body.editing .view-only { display: none !important; }
        
        /* Inputs in Edit Mode */
        body.editing input, body.editing textarea { 
            background: rgba(255,255,255,0.5); 
            border-bottom: 1px dashed #A2B8C4; 
            padding: 2px 4px;
            border-radius: 4px;
        }
        body.editing input:focus, body.editing textarea:focus { 
            background: #fff; 
            border-bottom: 2px solid #4D453E; 
            outline: none; 
        }

        /* Sticky Notes */
        .note-trigger { cursor: pointer; color: #F59E0B; transition: transform 0.2s; }
        .note-trigger:hover { transform: scale(1.2); }
        
        .sticky-note-card {
            display: none; /* Hidden by default */
            background-color: #FEF3C7;
            color: #4D453E;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15);
            font-family: 'Kalam', cursive;
            margin-top: 8px;
            position: relative;
            animation: fadeIn 0.2s;
            border: 1px solid #FCD34D;
        }
        .sticky-note-card.visible { display: block; }
        
        /* Timeline & Grid */
        .timeline-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start; border-left: 2px solid #E5E0D8; padding-right: 15px; position: relative; }
        .timeline-dot { position: absolute; right: -6px; top: 6px; width: 10px; height: 10px; background: #A2B8C4; border-radius: 50%; }
        .timeline-time { min-width: 60px; font-weight: bold; color: #4D453E; font-size: 0.9rem; }
        
        /* Layout */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loader */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4D453E; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Sync Status */
        #sync-status { position: fixed; bottom: 10px; left: 10px; font-size: 0.75rem; background: white; padding: 4px 8px; rounded: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        .sync-green { color: green; } .sync-red { color: red; }
    </style>
</head>
<body class="bg-[#F5F0E6] min-h-screen pb-24">

    <!-- Loading & Login -->
    <div id="loading-screen" style="display: none;"><div class="loader mb-4"></div><p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p></div>
    <div id="login-screen" class="fixed inset-0 bg-[#F5F0E6] flex flex-col items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-80">
            <div class="text-4xl mb-2">ğŸ‘¬</div>
            <h2 class="text-2xl font-bold text-[#4D453E]">×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™</h2>
            <input type="password" id="passcode-input" placeholder="×”×–×Ÿ ×§×•×“" class="w-full text-center text-2xl p-3 border-2 border-[#D8CFC7] rounded-xl my-4 outline-none">
            <button id="login-btn" class="w-full bg-[#4D453E] text-white font-bold py-3 rounded-xl shadow-lg">×›× ×™×¡×”</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">×§×•×“ ×©×’×•×™</p>
        </div>
    </div>

    <!-- Header & Controls -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-xl font-bold text-[#4D453E]">ğŸ‡³ğŸ‡´ ×˜×¨×•××¡×• 2026</h1>
                
                <!-- Controls -->
                <div class="flex gap-3 items-center">
                    <!-- Currency Toggle -->
                    <div class="flex items-center bg-gray-100 rounded-lg p-1">
                        <button id="btn-ils" class="px-2 py-1 rounded text-sm font-bold bg-white shadow text-[#4D453E]">â‚ª</button>
                        <button id="btn-eur" class="px-2 py-1 rounded text-sm font-bold text-gray-400">â‚¬</button>
                    </div>
                    
                    <!-- Edit Mode Toggle -->
                    <button id="edit-mode-btn" class="text-[#4D453E] border border-[#4D453E] px-3 py-1 rounded-lg text-sm font-bold hover:bg-[#4D453E] hover:text-white transition">
                        <i class="fa-solid fa-pen"></i> <span class="hidden md:inline">×¢×¨×™×›×”</span>
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex overflow-x-auto gap-6 text-sm md:text-base font-semibold text-gray-500 no-scrollbar pb-1">
                <button class="nav-link active text-[#4D453E] border-b-2 border-[#4D453E]" data-tab="itinerary">ğŸ“… ×œ×•×— ××¡×¢</button>
                <button class="nav-link" data-tab="flights">âœˆï¸ ×˜×™×¡×•×ª</button>
                <button class="nav-link" data-tab="car">ğŸš— ×¨×›×‘</button>
                <button class="nav-link" data-tab="accommodation">ğŸ  ×œ×™× ×”</button>
                <button class="nav-link" data-tab="supermarkets">ğŸ›’ ×¡×•×¤×¨</button>
                <button class="nav-link" data-tab="budget">ğŸ’° ×ª×§×¦×™×‘</button>
                <button class="nav-link" data-tab="checklist">ğŸ’ ×¦×™×•×“</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4">

        <!-- 1. Itinerary Tab -->
        <section id="itinerary" class="tab-content active">
            <div id="days-container" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <!-- Day Cards Injected Here -->
            </div>
        </section>

        <!-- 2. Flights Tab -->
        <section id="flights" class="tab-content">
            <div class="bg-white rounded-xl shadow p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">×¤×¨×˜×™ ×˜×™×¡×•×ª</h2>
                    <button class="edit-only bg-green-500 text-white px-2 py-1 rounded text-sm" onclick="addItem('flights')">+ ×˜×™×¡×”</button>
                </div>
                <div id="flights-list" class="space-y-4"></div>
            </div>
        </section>

        <!-- 3. Car Rental Tab -->
        <section id="car" class="tab-content">
            <div class="bg-white rounded-xl shadow p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">×”×©×›×¨×ª ×¨×›×‘</h2>
                    <button class="edit-only bg-green-500 text-white px-2 py-1 rounded text-sm" onclick="addItem('cars')">+ ×¨×›×‘</button>
                </div>
                <div class="bg-blue-50 p-3 rounded mb-4 text-sm">
                    <i class="fa-solid fa-info-circle"></i> ×—×•×‘×” ×¨×›×‘ 4x4. ××•××œ×¥ ×œ×•×•×“× ×©×™×© AutoPASS ×œ×›×‘×™×©×™ ××’×¨×”.
                </div>
                <div id="cars-list" class="space-y-4"></div>
            </div>
        </section>

        <!-- 4. Accommodation Tab -->
        <section id="accommodation" class="tab-content">
            <div class="bg-white rounded-xl shadow p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">××§×•××•×ª ×œ×™× ×”</h2>
                    <button class="edit-only bg-green-500 text-white px-2 py-1 rounded text-sm" onclick="addItem('housing')">+ ××§×•×</button>
                </div>
                <div id="housing-list" class="space-y-6"></div>
            </div>
        </section>

        <!-- 5. Supermarkets Tab -->
        <section id="supermarkets" class="tab-content">
            <div class="bg-white rounded-xl shadow p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">×¡×•×¤×¨××¨×§×˜×™× ×•××•×›×œ</h2>
                    <button class="edit-only bg-green-500 text-white px-2 py-1 rounded text-sm" onclick="addItem('markets')">+ ×¡×•×¤×¨</button>
                </div>
                <div class="bg-yellow-50 p-3 rounded mb-4 text-sm">
                    <i class="fa-solid fa-basket-shopping"></i> REMA 1000 ×•-KIWI ×”× ×”×–×•×œ×™× ×‘×™×•×ª×¨. ×‘×™×•× ×¨××©×•×Ÿ ×”×›×œ ×¡×’×•×¨ ×—×•×¥ ×-Joker (×™×§×¨).
                </div>
                <div id="markets-list" class="space-y-4"></div>
            </div>
        </section>

        <!-- 6. Budget Tab -->
        <section id="budget" class="tab-content">
            <div class="bg-white rounded-xl shadow p-5">
                <h2 class="text-xl font-bold mb-4">×¡×™×›×•× ×ª×§×¦×™×‘</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <div id="budget-breakdown" class="space-y-2 text-lg"></div>
                        <div class="mt-4 pt-4 border-t text-xl font-bold flex justify-between">
                            <span>×¡×”"×›:</span>
                            <span id="total-budget">0</span>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="budgetChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7. Checklist Tab -->
        <section id="checklist" class="tab-content">
            <div class="bg-white rounded-xl shadow p-5">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">×¨×©×™××ª ×¦×™×•×“</h2>
                    <div class="flex gap-2 edit-only">
                        <input type="text" id="new-check-item" placeholder="×¤×¨×™×˜ ×—×“×©..." class="border rounded px-2 py-1 text-sm">
                        <button onclick="addCheckItem()" class="bg-green-500 text-white px-2 rounded">+</button>
                    </div>
                </div>
                <div id="checklist-container" class="space-y-2"></div>
            </div>
        </section>

    </main>

    <!-- Edit Item Modal (Generic) -->
    <div id="day-edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4" id="modal-title">×¢×¨×™×›×ª ×™×•×</h3>
            <div id="modal-content" class="space-y-4"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500">×‘×™×˜×•×œ</button>
                <button id="save-modal-btn" class="px-4 py-2 bg-[#4D453E] text-white rounded-lg">×©××•×¨</button>
            </div>
        </div>
    </div>

    <div id="sync-status">×××ª×™×Ÿ...</div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBN9quYq8q01fOgDKliJ_IUq40F0askb_w",
            authDomain: "tromso-trip.firebaseapp.com",
            projectId: "tromso-trip",
            storageBucket: "tromso-trip.firebasestorage.app",
            messagingSenderId: "706076555674",
            appId: "1:706076555674:web:c7f3075199b975897fe223",
            measurementId: "G-976T7D2Q1Z"
        };

        let db, tripRef;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            tripRef = doc(db, "trips", "ofri_ami_final_v1");
        } catch (e) { console.error(e); }

        // --- App State ---
        let appData = {};
        let isEditMode = false;
        let currency = 'ILS'; // 'ILS' or 'EUR'
        const ILS_TO_EUR = 4.0; // 1 Euro = 4 ILS (approx for calculation)
        let chartInstance = null;

        // --- Default Data (The Research) ---
        const defaultData = {
            days: [
                { id: 1, date: '13/1 (×’\')', title: '× ×—×™×ª×” ×•×”×ª××¨×’× ×•×ª', cost: 200, currency: 'ILS', timeline: [
                    { time: '10:20', text: '× ×—×™×ª×” ×‘-AMS', sub: '×œ××¡×•×£ ×›×‘×•×“×” ×•×œ×¢×‘×•×¨ ×œ×˜×™×¡×ª ×”××©×š' },
                    { time: '14:00', text: '×˜×™×¡×” ×œ×˜×¨×•××¡×• (×“×¨×š OSL)', sub: 'SAS SK4414' },
                    { time: '18:00', text: '× ×—×™×ª×” ×‘×˜×¨×•××¡×•', sub: '××™×¡×•×£ ×¨×›×‘ ×-Hertz ×‘×©×“×”' },
                    { time: '19:30', text: '×§× ×™×•×ª ×‘-REMA 1000', sub: '×œ×™×“ ×”×©×“×”' }
                ], note: '×œ×§× ×•×ª ××™× ×•××•×›×œ ×œ×™×•××™×™× ×”×¨××©×•× ×™×.' },
                { id: 2, date: '14/1 (×“\')', title: '×”×¢×™×¨ ×˜×¨×•××¡×•', cost: 450, currency: 'ILS', timeline: [
                    { time: '10:00', text: '×—× ×™×” ×‘××¨×›×–', sub: '×× ×”×¨×ª Fjellet P-hus' },
                    { time: '11:30', text: '×¨×›×‘×œ Fjellheisen', sub: '× ×•×£ ×“××“×•××™×' },
                    { time: '14:00', text: '×¦×”×¨×™×™× ×‘-Rakettkiosken', sub: '×”× ×§× ×™×§×™×™×” ×”××¤×•×¨×¡××ª' },
                    { time: '20:00', text: '×¦×™×“ ×–×•×”×¨ ×¢×¦×××™', sub: '× ×¡×™×¢×” ×œ-Ersfjordbotn' }
                ] },
                { id: 3, date: '15/1 (×”\')', title: '×›×œ×‘×™× ×•×˜×‘×¢', cost: 1800, currency: 'ILS', timeline: [
                    { time: '09:00', text: '××–×—×œ×•×ª ×›×œ×‘×™×', sub: 'Villmarkssenter' },
                    { time: '13:00', text: '×× ×•×—×” ×‘×‘×§×ª×”', sub: '' },
                    { time: '18:00', text: '×¡××•× ×” ×‘× ××œ (Pust)', sub: '×œ×”×–××™×Ÿ ××¨××©!' }
                ] },
                { id: 4, date: '16/1 (×•\')', title: '××¢×‘×¨ ×œ×¡× ×™×”', cost: 600, currency: 'ILS', timeline: [
                    { time: '09:30', text: '× ×¡×™×¢×” ×œ-Brensholmen', sub: '×›-55 ×§"×, ×©×¢×” × ×¡×™×¢×”' },
                    { time: '11:00', text: '××¢×‘×•×¨×ª ×œ-Botnhamn', sub: '×œ×•×•×“× ×©×”×™× ×¤×¢×™×œ×” ×‘×‘×•×§×¨!' },
                    { time: '13:00', text: '×ª×¦×¤×™×ª Tungeneset', sub: '×”×¡×œ×¢×™× ×”××©×•× × ×™×' },
                    { time: '15:00', text: '×¦×§ ××™×Ÿ Mefjord Brygge', sub: '' }
                ] },
                { id: 5, date: '17/1 (×©\')', title: '×”××™ ×¡× ×™×”', cost: 0, currency: 'ILS', timeline: [
                    { time: '10:00', text: '×—×•×£ Ersfjord', sub: '×”×—×•×£ ×©×œ ×¡× ×™×”' },
                    { time: '12:00', text: '×ª×¦×¤×™×ª Bergsbotn', sub: '×”××¨×¤×¡×ª ×”×ª×œ×•×™×”' },
                    { time: '20:00', text: '×–×•×”×¨ ×‘×—×•×©×š ××•×—×œ×˜', sub: '××™×Ÿ ×–×™×”×•× ××•×¨ ×‘×¡× ×™×”' }
                ] },
                { id: 6, date: '18/1 (×\')', title: '×—×–×¨×” ×œ×˜×¨×•××¡×•', cost: 400, currency: 'ILS', timeline: [
                    { time: '10:00', text: '×™×¦×™××” ××¡× ×™×”', sub: '×“×¨×š ×”×™×‘×©×” ××• ××¢×‘×•×¨×ª' },
                    { time: '14:00', text: 'SommarÃ¸y', sub: '××™ ×”×§×™×¥ - ×—×•×¤×™× ×œ×‘× ×™×' },
                    { time: '19:00', text: '×¤××‘ Ã˜lhallen', sub: '×”×¤××‘ ×”×•×•×ª×™×§ ×‘×™×•×ª×¨' }
                ] },
                { id: 7, date: '19/1 (×‘\')', title: '×¤×¨×™×“×”', cost: 800, currency: 'ILS', timeline: [
                    { time: '11:00', text: '×§× ×™×•×ª ××–×›×¨×•×ª', sub: '×¨×—×•×‘ Storgata' },
                    { time: '13:00', text: '××•×–×™××•×Ÿ ×¤×•×œ××¨×™×”', sub: '' },
                    { time: '19:00', text: '××¨×•×—×ª ×¢×¨×‘ ×—×’×™×’×™×ª', sub: '××¡×¢×“×ª Fiskekompaniet' }
                ] },
                { id: 8, date: '20/1 (×’\')', title: '×˜×™×¡×” ×œ×××¡×˜×¨×“×', cost: 200, currency: 'ILS', timeline: [
                    { time: '10:00', text: '×”×—×–×¨×ª ×¨×›×‘ ×‘×©×“×”', sub: '' },
                    { time: '12:00', text: '×˜×™×¡×” ×œ-AMS', sub: '' },
                    { time: '18:00', text: '××œ×•×Ÿ ×‘×©×“×” ×”×ª×¢×•×¤×”', sub: 'CitizenM' }
                ] }
            ],
            flights: [
                { title: "×”×œ×•×š: AMS -> TOS", desc: "SAS, ×§×•× ×§×©×™×™×Ÿ ×‘××•×¡×œ×•. 13/1.", cost: 1800, note: "×›×•×œ×œ ×›×‘×•×“×” 23 ×§\"×’" },
                { title: "×—×–×•×¨: TOS -> AMS", desc: "Norwegian, 20/1 ×¦×”×¨×™×™×.", cost: 1600, note: "" },
                { title: "×—×–×•×¨: AMS -> TLV", desc: "××œ ×¢×œ, 21/1 ×‘-11:30.", cost: 2000, note: "" }
            ],
            cars: [
                { title: "Hertz Tromso Airport", desc: "Toyota RAV4 4x4 (×—×•×‘×”!).", cost: 4500, note: "×›×•×œ×œ ×‘×™×˜×•×œ ×”×©×ª×ª×¤×•×ª ×¢×¦××™×ª. ××™×¡×•×£ 13/1 18:00." },
                { title: "×“×œ×§ ×•××’×¨×•×ª", desc: "×”×¢×¨×›×” ×œ-800 ×§\"× + ××¢×‘×•×¨×•×ª.", cost: 1500, note: "×ª×©×œ×•× ×“×¨×š AutoPass ×‘×¨×›×‘" }
            ],
            housing: [
                { title: "KvalÃ¸ya - Ersfjordbotn", desc: "×‘×§×ª×” ×¢×œ ×”××™×, 3 ×œ×™×œ×•×ª.", cost: 3200, address: "Ersfjordbotn Brygge", link: "https://airbnb.com" },
                { title: "Senja - Mefjord Brygge", desc: "×“×™×¨×ª × ×•×¤×©, 2 ×œ×™×œ×•×ª.", cost: 2400, address: "MefjordvÃ¦r", link: "https://mefjordbrygge.no" },
                { title: "Tromso City - Smart Hotel", desc: "×œ×™×œ×” ××—×¨×•×Ÿ ×‘×¢×™×¨.", cost: 800, address: "Vestregata 6", link: "" },
                { title: "AMS Airport - CitizenM", desc: "×œ×™×œ×” ×œ×¤× ×™ ×˜×™×¡×” ×œ××¨×¥.", cost: 900, address: "Schiphol", link: "" }
            ],
            markets: [
                { title: "REMA 1000 KvalÃ¸ysletta", desc: "×”×–×•×œ ×•×”×’×“×•×œ ×‘×™×•×ª×¨ ×‘×™×¦×™××” ××”×¢×™×¨.", cost: 1200, note: "×œ×§× ×•×ª ×”×›×œ ×›××Ÿ!" },
                { title: "Joker Skaland (Senja)", desc: "×¡×•×¤×¨ ×§×˜×Ÿ ×•×™×§×¨ ×‘×¡× ×™×”.", cost: 300, note: "×¨×§ ×œ×”×©×œ××•×ª" },
                { title: "Eurospar", desc: "××‘×—×¨ ×’×“×•×œ ×©×œ ×‘×©×¨ ×˜×¨×™.", cost: 0, note: "" }
            ],
            checklist: [
                { text: "×‘×™×’×•×“ ×ª×¨××™ (2 ×¡×˜×™×)", done: false, note: "××¨×™× ×• ×‘×œ×‘×“" },
                { text: "×—×¦×•×‘×” ×œ××¦×œ××”", done: false, note: "×—×•×‘×” ×œ×–×•×”×¨" },
                { text: "×¨×™×©×™×•×Ÿ × ×”×™×’×” ×‘×™× ×œ××•××™", done: false, note: "×‘× ×•×¡×£ ×œ×¤×œ×¡×˜×™×§" },
                { text: "××˜×¢×Ÿ × ×™×™×“", done: false, note: "×¡×•×œ×œ×•×ª ××ª×•×ª ×‘×§×•×¨" },
                { text: "××œ×›×•×”×•×œ ××”×“×™×•×˜×™", done: false, note: "×™×§×¨ ×××•×“ ×©×" }
            ]
        };

        // --- Formatters ---
        function formatPrice(ilsValue) {
            if (!ilsValue) return currency === 'ILS' ? '0 â‚ª' : '0 â‚¬';
            if (currency === 'ILS') return `â‚ª${parseInt(ilsValue).toLocaleString()}`;
            return `â‚¬${(parseInt(ilsValue) / ILS_TO_EUR).toFixed(0)}`;
        }

        // --- Render Logic ---
        
        // 1. ITINERARY
        function renderItinerary() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            
            (appData.days || []).forEach((day, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition';
                
                // Timeline HTML
                let timelineHtml = '';
                if (day.timeline) {
                    timelineHtml = day.timeline.map((t, tIndex) => `
                        <div class="timeline-row group">
                            <div class="timeline-dot"></div>
                            <div class="timeline-time">${t.time}</div>
                            <div class="flex-1">
                                <div class="font-medium view-only">${t.text}</div>
                                <input class="edit-only w-full mb-1" value="${t.text}" onchange="updateTimeline(${index}, ${tIndex}, 'text', this.value)">
                                
                                <div class="text-xs text-gray-500 view-only">${t.sub || ''}</div>
                                <input class="edit-only w-full text-xs" value="${t.sub || ''}" placeholder="×¤×™×¨×•×˜" onchange="updateTimeline(${index}, ${tIndex}, 'sub', this.value)">
                            </div>
                            <button class="edit-only text-red-400 hover:text-red-600" onclick="removeTimelineItem(${index}, ${tIndex})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `).join('');
                }

                // Note HTML
                const noteHtml = `
                    <div class="relative inline-block">
                        <i class="fa-regular fa-note-sticky note-trigger text-lg" onclick="toggleNote('day-${index}')"></i>
                        <div id="note-day-${index}" class="sticky-note-card ${day.note ? '' : 'hidden'}">
                            <textarea class="bg-transparent w-full h-full outline-none resize-none text-sm" 
                                      ${isEditMode ? '' : 'readonly'} 
                                      onchange="updateDay(${index}, 'note', this.value)">${day.note || ''}</textarea>
                            ${isEditMode ? `<div class="text-xs text-gray-400 mt-1 text-left cursor-pointer" onclick="updateDay(${index}, 'note', '')">× ×§×”</div>` : ''}
                        </div>
                    </div>
                `;

                // Cost Input
                const costInput = `
                    <div class="mt-3 pt-3 border-t flex justify-between items-center">
                        <div class="text-sm font-bold text-green-600 view-only">${formatPrice(day.cost)}</div>
                        <div class="flex items-center gap-1 edit-only">
                            <span class="text-xs">×¢×œ×•×ª:</span>
                            <input type="number" value="${day.cost || 0}" class="w-20 text-sm" onchange="updateDay(${index}, 'cost', this.value)">
                        </div>
                        ${noteHtml}
                    </div>
                `;

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="bg-[#4D453E] text-white px-2 py-1 rounded text-sm font-bold">${day.date}</span>
                        ${isEditMode ? `<button class="text-red-500 text-sm" onclick="deleteDay(${index})"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                    
                    <h3 class="text-lg font-bold text-[#4D453E] mb-1 view-only">${day.title}</h3>
                    <input class="edit-only text-lg font-bold text-[#4D453E] w-full mb-2" value="${day.title}" onchange="updateDay(${index}, 'title', this.value)">
                    
                    <div class="mt-4">${timelineHtml}</div>
                    
                    <button class="edit-only w-full mt-2 text-sm text-gray-400 border border-dashed border-gray-300 rounded py-1" onclick="addTimelineItem(${index})">+ ×”×•×¡×£ ×¤×¢×™×œ×•×ª</button>
                    
                    ${costInput}
                `;
                container.appendChild(card);
            });
            
            if(isEditMode) {
                const addBtn = document.createElement('button');
                addBtn.className = 'w-full py-4 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl font-bold hover:bg-gray-50';
                addBtn.textContent = '+ ×”×•×¡×£ ×™×•× ×—×“×©';
                addBtn.onclick = () => {
                    appData.days.push({date: '×ª××¨×™×š', title: '×™×•× ×—×“×©', timeline: [], cost: 0});
                    saveData();
                };
                container.appendChild(addBtn);
            }
        }

        // 2. GENERIC LIST RENDERER (Flights, Cars, Housing, Markets)
        function renderList(key, containerId, iconClass) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            (appData[key] || []).forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col p-3 border-b border-gray-100 last:border-0 relative group hover:bg-gray-50 rounded transition';
                
                // Determine display classes based on mode
                const viewClass = isEditMode ? 'hidden' : 'block';
                const editClass = isEditMode ? 'block' : 'hidden';

                // Note Logic
                const noteId = `${key}-${index}`;
                const noteHtml = `
                    <div class="mt-2">
                        <div class="flex items-center gap-2">
                            <i class="fa-regular fa-note-sticky note-trigger text-sm" onclick="toggleNote('${noteId}')"></i>
                            <span class="text-xs text-gray-400 ${!item.note ? 'hidden' : ''} view-only">×™×© ×”×¢×¨×”</span>
                        </div>
                        <div id="note-${noteId}" class="sticky-note-card ${item.note ? '' : 'hidden'}">
                            <textarea class="bg-transparent w-full outline-none resize-none text-sm" 
                                      rows="2" ${!isEditMode ? 'readonly' : ''}
                                      onchange="updateItem('${key}', ${index}, 'note', this.value)">${item.note || ''}</textarea>
                        </div>
                    </div>
                `;

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-bold text-[#4D453E] view-only text-lg">${item.title}</div>
                            <input class="edit-only font-bold text-[#4D453E] w-full text-lg" value="${item.title}" onchange="updateItem('${key}', ${index}, 'title', this.value)">
                            
                            <div class="text-sm text-gray-600 view-only mt-1">${item.desc || ''}</div>
                            <textarea class="edit-only w-full text-sm mt-1" rows="2" onchange="updateItem('${key}', ${index}, 'desc', this.value)">${item.desc || ''}</textarea>
                            
                            ${item.address ? `<div class="text-xs text-gray-400 mt-1"><i class="fa-solid fa-location-dot"></i> ${item.address}</div>` : ''}
                            ${isEditMode && key === 'housing' ? `<input class="edit-only w-full text-xs mt-1" placeholder="×›×ª×•×‘×ª" value="${item.address || ''}" onchange="updateItem('${key}', ${index}, 'address', this.value)">` : ''}
                            
                            ${item.link ? `<a href="${item.link}" target="_blank" class="text-xs text-blue-500 mt-1 inline-block view-only">ğŸ”— ×œ×™× ×§ ×œ×”×–×× ×”</a>` : ''}
                            <input class="edit-only w-full text-xs mt-1" placeholder="URL ×œ×”×–×× ×”" value="${item.link || ''}" onchange="updateItem('${key}', ${index}, 'link', this.value)">
                        </div>
                        
                        <div class="text-left pl-2 min-w-[80px]">
                            <div class="font-bold text-green-600 view-only">${formatPrice(item.cost)}</div>
                            <input type="number" class="edit-only w-20 text-sm" value="${item.cost || 0}" onchange="updateItem('${key}', ${index}, 'cost', this.value)">
                            ${isEditMode ? `<button class="text-red-400 text-xs mt-2 block w-full text-right" onclick="deleteItem('${key}', ${index})">××—×§</button>` : ''}
                        </div>
                    </div>
                    ${noteHtml}
                `;
                container.appendChild(div);
            });
        }

        // 3. BUDGET
        function renderBudget() {
            const breakdown = document.getElementById('budget-breakdown');
            let total = 0;
            const categories = {
                days: { label: '××˜×¨×§×¦×™×•×ª ×•×©×•× ×•×ª (×™×•××™)', sum: 0, color: '#F59E0B' },
                flights: { label: '×˜×™×¡×•×ª', sum: 0, color: '#3B82F6' },
                cars: { label: '×¨×›×‘ ×•×“×œ×§', sum: 0, color: '#EF4444' },
                housing: { label: '×œ×™× ×”', sum: 0, color: '#10B981' },
                markets: { label: '××•×›×œ ×•×¡×•×¤×¨', sum: 0, color: '#8B5CF6' }
            };

            // Calculate
            (appData.days || []).forEach(d => { total += parseInt(d.cost || 0); categories.days.sum += parseInt(d.cost || 0); });
            ['flights', 'cars', 'housing', 'markets'].forEach(cat => {
                (appData[cat] || []).forEach(i => {
                    total += parseInt(i.cost || 0);
                    categories[cat].sum += parseInt(i.cost || 0);
                });
            });

            // Render Text
            breakdown.innerHTML = Object.values(categories).map(cat => `
                <div class="flex justify-between border-b border-gray-100 py-1">
                    <span class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background:${cat.color}"></div> ${cat.label}</span>
                    <span>${formatPrice(cat.sum)}</span>
                </div>
            `).join('');
            
            document.getElementById('total-budget').textContent = formatPrice(total);

            // Render Chart
            const ctx = document.getElementById('budgetChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(categories).map(c => c.label),
                    datasets: [{
                        data: Object.values(categories).map(c => c.sum),
                        backgroundColor: Object.values(categories).map(c => c.color),
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // 4. CHECKLIST
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';
            (appData.checklist || []).forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-3 p-2 border-b border-gray-100';
                div.innerHTML = `
                    <input type="checkbox" class="mt-1" ${item.done ? 'checked' : ''} onchange="toggleCheck(${index})">
                    <div class="flex-1">
                        <span class="${item.done ? 'line-through text-gray-400' : ''} text-lg view-only">${item.text}</span>
                        <input class="edit-only w-full" value="${item.text}" onchange="updateCheck(${index}, 'text', this.value)">
                        
                        <div class="text-xs text-gray-500 ${!item.note ? 'hidden' : ''} view-only">ğŸ’¡ ${item.note}</div>
                        <input class="edit-only w-full text-xs mt-1 text-gray-500" placeholder="×”×¢×¨×”..." value="${item.note || ''}" onchange="updateCheck(${index}, 'note', this.value)">
                    </div>
                    ${isEditMode ? `<button class="text-red-400" onclick="deleteCheck(${index})">ğŸ—‘ï¸</button>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // --- Global Actions ---
        window.toggleNote = (id) => {
            const el = document.getElementById(`note-${id}`);
            el.classList.toggle('visible');
            // If edit mode, focus textarea
            if (isEditMode && el.classList.contains('visible')) {
                el.querySelector('textarea').focus();
            }
        };

        // Data Update Wrappers
        window.updateDay = (idx, field, val) => { appData.days[idx][field] = val; saveData(); renderItinerary(); renderBudget(); };
        window.updateTimeline = (dIdx, tIdx, field, val) => { appData.days[dIdx].timeline[tIdx][field] = val; saveData(); };
        window.addTimelineItem = (dIdx) => { if(!appData.days[dIdx].timeline) appData.days[dIdx].timeline=[]; appData.days[dIdx].timeline.push({time:'', text:''}); saveData(); renderItinerary(); };
        window.removeTimelineItem = (dIdx, tIdx) => { appData.days[dIdx].timeline.splice(tIdx, 1); saveData(); renderItinerary(); };
        window.deleteDay = (idx) => { if(confirm('×œ××—×•×§ ×™×•×?')) { appData.days.splice(idx, 1); saveData(); renderItinerary(); renderBudget(); } };

        window.updateItem = (key, idx, field, val) => { appData[key][idx][field] = val; saveData(); renderBudget(); }; // Note: No re-render needed usually for input change, but needed for price format updates
        window.deleteItem = (key, idx) => { if(confirm('×œ××—×•×§?')) { appData[key].splice(idx, 1); saveData(); refreshAll(); } };
        window.addItem = (key) => { if(!appData[key]) appData[key]=[]; appData[key].push({title:'', desc:'', cost:0}); saveData(); refreshAll(); };

        window.toggleCheck = (idx) => { appData.checklist[idx].done = !appData.checklist[idx].done; saveData(); renderChecklist(); };
        window.updateCheck = (idx, field, val) => { appData.checklist[idx][field] = val; saveData(); };
        window.deleteCheck = (idx) => { appData.checklist.splice(idx, 1); saveData(); renderChecklist(); };
        window.addCheckItem = () => { const inp = document.getElementById('new-check-item'); if(inp.value) { appData.checklist.push({text: inp.value, done: false}); inp.value=''; saveData(); renderChecklist(); } };

        function refreshAll() {
            renderItinerary();
            renderList('flights', 'flights-list');
            renderList('cars', 'cars-list');
            renderList('housing', 'housing-list');
            renderList('markets', 'markets-list');
            renderBudget();
            renderChecklist();
        }

        // --- Core Logic ---
        async function saveData() {
            document.getElementById('sync-status').textContent = '×©×•××¨...';
            try { await updateDoc(tripRef, appData); document.getElementById('sync-status').textContent = '×¡×•× ×›×¨×Ÿ'; } 
            catch (e) { console.error(e); }
        }

        // Auth
        const CORRECT_CODE = '8989';
        document.getElementById('login-btn').addEventListener('click', () => {
            if(document.getElementById('passcode-input').value === CORRECT_CODE) {
                document.getElementById('login-screen').style.display = 'none';
                initFirebaseListener();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        function initFirebaseListener() {
            onSnapshot(tripRef, async (docSnap) => {
                if (docSnap.exists()) {
                    appData = docSnap.data();
                } else {
                    await setDoc(tripRef, defaultData); // Upload default if empty
                    appData = defaultData;
                }
                refreshAll();
            });
        }

        // UI Toggles
        const btnIls = document.getElementById('btn-ils');
        const btnEur = document.getElementById('btn-eur');
        
        function setCurrency(c) {
            currency = c;
            if(c === 'ILS') {
                btnIls.className = "px-2 py-1 rounded text-sm font-bold bg-white shadow text-[#4D453E]";
                btnEur.className = "px-2 py-1 rounded text-sm font-bold text-gray-400";
            } else {
                btnEur.className = "px-2 py-1 rounded text-sm font-bold bg-white shadow text-[#4D453E]";
                btnIls.className = "px-2 py-1 rounded text-sm font-bold text-gray-400";
            }
            refreshAll(); // Re-render prices
        }
        btnIls.onclick = () => setCurrency('ILS');
        btnEur.onclick = () => setCurrency('EUR');

        const editBtn = document.getElementById('edit-mode-btn');
        editBtn.onclick = () => {
            isEditMode = !isEditMode;
            document.body.classList.toggle('editing', isEditMode);
            editBtn.innerHTML = isEditMode ? '<i class="fa-solid fa-check"></i> <span class="hidden md:inline">×¡×™×•×</span>' : '<i class="fa-solid fa-pen"></i> <span class="hidden md:inline">×¢×¨×™×›×”</span>';
            editBtn.className = isEditMode ? "bg-[#4D453E] text-white px-3 py-1 rounded-lg text-sm font-bold" : "text-[#4D453E] border border-[#4D453E] px-3 py-1 rounded-lg text-sm font-bold";
            refreshAll(); // Re-render to show/hide inputs
        };

        // Tab Navigation
        const navLinks = document.querySelectorAll('.nav-link');
        const tabs = document.querySelectorAll('.tab-content');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navLinks.forEach(n => { n.classList.remove('active'); n.classList.remove('border-b-2'); n.classList.remove('text-[#4D453E]'); });
                tabs.forEach(t => t.classList.remove('active'));
                
                link.classList.add('active', 'border-b-2', 'border-[#4D453E]', 'text-[#4D453E]');
                document.getElementById(link.dataset.tab).classList.add('active');
            });
        });

    </script>
</body>
</html>
