<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™ ğŸ³ï¸â€ğŸŒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #F3F4F6; color: #1F2937; -webkit-tap-highlight-color: transparent; }
        
        /* State Visibility classes */
        body:not(.editing) .edit-only { display: none !important; }
        body.editing .view-only { display: none !important; }
        body.editing .editable-container { border: 1px dashed #9CA3AF; padding: 4px; border-radius: 4px; background: rgba(255,255,255,0.5); }

        /* Inputs */
        input, textarea, select { background: transparent; border-bottom: 1px solid #D1D5DB; outline: none; transition: border 0.3s; width: 100%; }
        body.editing input:focus, body.editing textarea:focus { border-bottom: 2px solid #4F46E5; background: #fff; }

        /* Timeline */
        .timeline-row { position: relative; padding-right: 20px; border-right: 2px solid #E5E7EB; padding-bottom: 20px; }
        .timeline-row:last-child { border-right: none; }
        .timeline-dot { position: absolute; right: -6px; top: 0; width: 10px; height: 10px; background: #4F46E5; border-radius: 50%; border: 2px solid white; }
        
        /* Booked Badge */
        .badge-booked { background-color: #DCFCE7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; border: 1px solid #86EFAC; }
        .badge-pending { background-color: #F3F4F6; color: #6B7280; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid #D1D5DB; }

        /* Option Card (Selected vs Alternative) */
        .option-card { border: 1px solid #E5E7EB; padding: 10px; border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; background: white; }
        .option-card.selected { border: 2px solid #4F46E5; background: #EEF2FF; }
        .option-card:not(.selected) { opacity: 0.7; }
        .option-card:not(.selected):hover { opacity: 1; border-color: #A5B4FC; cursor: pointer; }

        /* Sticky Notes */
        .note-trigger { color: #F59E0B; cursor: pointer; }
        .sticky-note { background: #FEF3C7; padding: 8px; border-radius: 6px; font-family: 'Kalam', cursive; font-size: 0.9rem; margin-top: 5px; border: 1px solid #FCD34D; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }

        /* Tabs */
        .tab-btn.active { color: #4F46E5; border-bottom: 2px solid #4F46E5; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <!-- Loading & Login -->
    <div id="loading-screen"><div class="loader mb-4"></div><p class="text-gray-600 font-bold">×˜×•×¢×Ÿ ××ª ×”×˜×™×•×œ...</p></div>
    
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-80">
            <div class="text-4xl mb-4">ğŸ‘¬</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™</h2>
            <input type="password" id="passcode-input" placeholder="×”×–×Ÿ ×§×•×“" class="w-full text-center text-2xl p-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-indigo-500">
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow hover:bg-indigo-700 transition">×›× ×™×¡×”</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">×§×•×“ ×©×’×•×™</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ‡³ğŸ‡´</span>
                    <h1 class="text-lg font-bold text-gray-800 leading-tight">×˜×¨×•××¡×• 2026<br><span class="text-xs text-gray-500 font-normal">×¢×¤×¨×™ & ×¢××™</span></h1>
                </div>
                
                <div class="flex gap-2">
                    <!-- Currency Toggle -->
                    <button id="currency-btn" class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-bold border border-gray-200 shadow-sm" onclick="toggleCurrency()">
                        â‚ª <span class="text-gray-400 mx-1">|</span> â‚¬
                    </button>
                    <!-- Edit Toggle -->
                    <button id="edit-btn" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-sm font-bold border border-indigo-200" onclick="toggleEditMode()">
                        âœï¸ ×¢×¨×™×›×”
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex overflow-x-auto gap-6 text-sm font-medium text-gray-500 no-scrollbar pb-1 border-b border-gray-100">
                <button class="tab-btn active whitespace-nowrap pb-2" onclick="switchTab('itinerary')">ğŸ“… ×œ×•×— ××¡×¢</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('logistics')">âœˆï¸ ×œ×•×’×™×¡×˜×™×§×” ×•×œ×™× ×”</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('checklist')">ğŸ’ ×¦×™×•×“</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('budget')">ğŸ’° ×ª×§×¦×™×‘</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4">

        <!-- TAB 1: ITINERARY -->
        <section id="itinerary" class="tab-content active">
            <div id="days-container" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
            <button class="edit-only w-full py-3 mt-4 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl font-bold hover:bg-white hover:border-indigo-300" onclick="addDay()">+ ×”×•×¡×£ ×™×•× ×—×“×©</button>
        </section>

        <!-- TAB 2: LOGISTICS (Accommodation, Flights, Car, Markets) -->
        <section id="logistics" class="tab-content">
            
            <!-- Flights Section -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">âœˆï¸ ×˜×™×¡×•×ª</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('flights')">+ ×˜×™×¡×”</button>
                </div>
                <div id="flights-container" class="space-y-4"></div>
            </div>

            <!-- Accommodation Section (Sorted by date) -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ  ×œ×™× ×” (×œ×¤×™ ×¡×“×¨ ×”××¡×¢)</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('housing')">+ ××§×•× ×œ×™× ×”</button>
                </div>
                <div id="housing-container" class="space-y-4"></div>
            </div>

            <!-- Car Section -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">ğŸš— ×¨×›×‘ ×©×›×•×¨</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('cars')">+ ×¨×›×‘</button>
                </div>
                <div id="cars-container" class="space-y-4"></div>
            </div>

            <!-- Markets Section -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ›’ ×¡×•×¤×¨××¨×§×˜×™×</h2>
                    <button class="edit-only text-sm bg-indigo-100 text-indigo-700 px-2 py-1 rounded" onclick="addGroup('markets')">+ ×¡×•×¤×¨</button>
                </div>
                <div id="markets-container" class="space-y-4"></div>
            </div>
        </section>

        <!-- TAB 3: CHECKLIST -->
        <section id="checklist" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
                <h2 class="text-lg font-bold mb-4 text-gray-800">×¨×©×™××ª ×¦×™×•×“ ×—×•×¨×£</h2>
                <div class="flex gap-2 mb-4 edit-only">
                    <input type="text" id="new-item-text" placeholder="×¤×¨×™×˜..." class="border rounded px-2 py-1 text-sm">
                    <input type="number" id="new-item-price" placeholder="××—×™×¨" class="border rounded px-2 py-1 text-sm w-20">
                    <button onclick="addCheckItem()" class="bg-indigo-600 text-white px-3 rounded font-bold">+</button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-2 py-2 text-right">×¡×˜×˜×•×¡</th>
                                <th scope="col" class="px-2 py-2 text-right">×¤×¨×™×˜</th>
                                <th scope="col" class="px-2 py-2 text-right">××§×•×¨/×”×¢×¨×”</th>
                                <th scope="col" class="px-2 py-2 text-right">×¢×œ×•×ª</th>
                                <th scope="col" class="px-2 py-2 edit-only"></th>
                            </tr>
                        </thead>
                        <tbody id="checklist-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TAB 4: BUDGET -->
        <section id="budget" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <h2 class="text-xl font-bold mb-6 text-gray-800">× ×™×”×•×œ ×ª×§×¦×™×‘</h2>
                
                <div class="grid md:grid-cols-2 gap-8 items-center mb-8">
                    <div class="h-64 w-full flex justify-center">
                        <canvas id="budgetChart"></canvas>
                    </div>
                    <div>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-100 mb-3">
                            <span class="block text-sm text-green-600 font-bold">×©×•×œ× / ×”×•×–××Ÿ âœ…</span>
                            <span id="total-paid" class="text-2xl font-bold text-green-700">0</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-3">
                            <span class="block text-sm text-gray-500 font-bold">× ×•×ª×¨ ×œ×©×œ× ğŸ•’</span>
                            <span id="total-future" class="text-2xl font-bold text-gray-700">0</span>
                        </div>
                        <div class="border-t pt-3 mt-3">
                            <span class="block text-sm text-gray-400">×¡×š ×”×›×œ ××©×•×¢×¨</span>
                            <span id="total-sum" class="text-3xl font-bold text-indigo-600">0</span>
                        </div>
                    </div>
                </div>
                
                <div id="budget-details" class="space-y-2 text-sm"></div>
            </div>
        </section>

    </main>

    <!-- Generic Item Modal (For Timeline Details) -->
    <div id="details-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-gray-800">×¤×¨×˜×™×</h3>
            <div id="modal-content" class="text-gray-600 mb-6 space-y-3"></div>
            <button onclick="closeModal()" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl">×¡×’×•×¨</button>
        </div>
    </div>

    <div id="sync-indicator" class="fixed bottom-4 left-4 bg-white shadow px-3 py-1 rounded-full text-xs font-bold text-gray-400 z-50">××¡×•× ×›×¨×Ÿ</div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBN9quYq8q01fOgDKliJ_IUq40F0askb_w",
            authDomain: "tromso-trip.firebaseapp.com",
            projectId: "tromso-trip",
            storageBucket: "tromso-trip.firebasestorage.app",
            messagingSenderId: "706076555674",
            appId: "1:706076555674:web:c7f3075199b975897fe223",
            measurementId: "G-976T7D2Q1Z"
        };

        let app, db, tripRef;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            tripRef = doc(db, "trips", "ofri_ami_v3_final"); 
        } catch (e) { console.error(e); }

        // --- DATA STRUCTURE ---
        // Structure: days[], logistics{ flights[], housing[], cars[], markets[] }, checklist[]
        // Each Logistic Group: { id, title, date, options: [ {id, name, desc, cost, booked, link, bookingInfo} ], selectedOptionId }
        
        let appData = {
            currency: 'ILS',
            days: [
                { id: 1, date: '13/1 (×’\')', title: '× ×—×™×ª×”', timeline: [
                    { id: 101, time: '14:00', title: '×˜×™×¡×” ×œ-TOS', desc: 'SAS ×“×¨×š ××•×¡×œ×•', cost: 0, booked: true, info: 'PNR: ABC1234' },
                    { id: 102, time: '18:00', title: '××™×¡×•×£ ×¨×›×‘', desc: 'Hertz ×‘×©×“×”', cost: 0, booked: false, info: '' }
                ], summaryCost: 0 },
                { id: 2, date: '14/1 (×“\')', title: '×˜×¨×•××¡×•', timeline: [
                    { id: 201, time: '11:00', title: '×¨×›×‘×œ Fjellheisen', desc: '×›×¨×˜×™×¡ ×–×•×’×™', cost: 250, booked: false, info: '' }
                ], summaryCost: 0 }
            ],
            logistics: {
                flights: [
                    { id: 'f1', title: '×˜×™×¡×•×ª ×”×œ×•×š ×—×–×•×¨', options: [
                        { id: 'o1', name: 'SAS + Norwegian', desc: '×©×¢×•×ª × ×•×—×•×ª', cost: 3500, booked: true, link: '', info: '×”×•×–××Ÿ ×“×¨×š Skyscanner' }
                    ], selectedId: 'o1' }
                ],
                housing: [
                    { id: 'h1', title: '×œ×™× ×” ×‘×˜×¨×•××¡×• (×™××™× 1-3)', date: '2026-01-13', options: [
                        { id: 'opt1', name: 'Airbnb Ersfjord', desc: '×‘×§×ª×” ×¢×œ ×”××™×', cost: 3200, booked: false, link: 'https://airbnb.com', info: '' },
                        { id: 'opt2', name: 'Clarion Hotel', desc: '×‘××¨×›×– ×”×¢×™×¨', cost: 4000, booked: false, link: '', info: '' }
                    ], selectedId: 'opt1' }
                ],
                cars: [
                    { id: 'c1', title: '×¨×›×‘ ×œ×›×œ ×”×ª×§×•×¤×”', options: [
                        { id: 'o1', name: 'Toyota RAV4', desc: 'Hertz', cost: 4500, booked: false, link: '', info: '' },
                        { id: 'o2', name: 'Suzuki Vitara', desc: 'Sixt', cost: 3800, booked: false, link: '', info: '' }
                    ], selectedId: 'o1' }
                ],
                markets: [
                    { id: 'm1', title: '×§× ×™×•×ª ×œ×”×’×¢×”', date: '2026-01-13', options: [
                        { id: 'o1', name: 'REMA 1000', desc: '×œ×™×“ ×”×©×“×”', cost: 800, booked: false, info: '' }
                    ], selectedId: 'o1'}
                ]
            },
            checklist: [
                { id: 1, text: '×‘×™×’×•×“ ×ª×¨××™', source: '×“×§×˜×œ×•×Ÿ', cost: 400, gotIt: true },
                { id: 2, text: '×§×¨××¤×•× ×™×', source: '×××–×•×Ÿ', cost: 100, gotIt: false }
            ]
        };

        let isEditMode = false;
        let currentCurrency = 'ILS';
        const EUR_RATE = 4;
        let chartInstance = null;

        // --- STATE & HELPERS ---
        window.toggleEditMode = () => {
            isEditMode = !isEditMode;
            document.body.classList.toggle('editing', isEditMode);
            document.getElementById('edit-btn').innerHTML = isEditMode ? 'âœ… ×¡×™×•× ×¢×¨×™×›×”' : 'âœï¸ ×¢×¨×™×›×”';
            document.getElementById('edit-btn').classList.toggle('bg-green-100', isEditMode);
            document.getElementById('edit-btn').classList.toggle('text-green-700', isEditMode);
            renderAll();
        };

        window.toggleCurrency = () => {
            currentCurrency = currentCurrency === 'ILS' ? 'EUR' : 'ILS';
            const btn = document.getElementById('currency-btn');
            btn.innerHTML = currentCurrency === 'ILS' ? '<b>â‚ª</b> <span class="text-gray-400 mx-1">|</span> â‚¬' : 'â‚ª <span class="text-gray-400 mx-1">|</span> <b>â‚¬</b>';
            renderAll();
        };

        function formatPrice(ils) {
            if (!ils) return currentCurrency === 'ILS' ? '0 â‚ª' : '0 â‚¬';
            if (currentCurrency === 'ILS') return `â‚ª${parseInt(ils).toLocaleString()}`;
            return `â‚¬${(parseInt(ils) / EUR_RATE).toFixed(0)}`;
        }

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        // --- RENDERERS ---

        // 1. Itinerary Renderer
        function renderItinerary() {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            
            appData.days.forEach((day, dayIdx) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-4';
                
                let dailyTotal = 0;
                
                const timelineHtml = day.timeline.map((item, itemIdx) => {
                    dailyTotal += parseInt(item.cost || 0);
                    const bookedBadge = item.booked ? 
                        `<span class="badge-booked" onclick="showDetails('${item.info || '×”×•×–××Ÿ'}')">âœ”ï¸ ×”×•×–××Ÿ</span>` : 
                        `<span class="badge-pending hidden">×œ× ×”×•×–××Ÿ</span>`; // Only show booked in view mode usually, but user asked for info
                    
                    const editControls = `
                        <div class="edit-only mt-2 bg-gray-50 p-2 rounded border border-dashed border-gray-300">
                            <div class="flex gap-2 mb-1">
                                <input type="time" value="${item.time}" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'time', this.value)" class="w-20">
                                <input type="text" value="${item.title}" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'title', this.value)" class="font-bold">
                            </div>
                            <input type="text" value="${item.desc}" placeholder="×ª×™××•×¨" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'desc', this.value)" class="text-xs mb-1">
                            <div class="flex gap-2 items-center">
                                <input type="number" value="${item.cost}" placeholder="××—×™×¨" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'cost', this.value)" class="w-20 text-xs">
                                <label class="flex items-center gap-1 text-xs cursor-pointer">
                                    <input type="checkbox" class="w-4 h-4" ${item.booked ? 'checked' : ''} onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'booked', this.checked)">
                                    ×”×•×–××Ÿ?
                                </label>
                            </div>
                            <input type="text" value="${item.info || ''}" placeholder="×¤×¨×˜×™ ×”×–×× ×”/××™×“×¢ × ×•×¡×£" onchange="updateTimeline(${dayIdx}, ${itemIdx}, 'info', this.value)" class="text-xs mt-1 w-full border rounded px-1">
                            <button onclick="deleteTimelineItem(${dayIdx}, ${itemIdx})" class="text-red-500 text-xs mt-1">××—×§</button>
                        </div>
                    `;

                    return `
                        <div class="timeline-row pb-4">
                            <div class="timeline-dot"></div>
                            <div class="flex justify-between items-start cursor-pointer view-only hover:bg-gray-50 p-1 rounded" onclick="showTimelineDetails(${dayIdx}, ${itemIdx})">
                                <div>
                                    <span class="font-bold text-indigo-900">${item.time}</span>
                                    <span class="font-bold mr-2">${item.title}</span>
                                    <div class="text-sm text-gray-600 pr-12">${item.desc}</div>
                                    <div class="pr-12 mt-1 flex gap-2 items-center">
                                        ${bookedBadge}
                                        ${item.cost > 0 ? `<span class="text-xs bg-gray-100 px-2 rounded">${formatPrice(item.cost)}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${editControls}
                        </div>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <input class="font-bold text-lg text-gray-800 bg-transparent edit-only" value="${day.title}" onchange="updateDay(${dayIdx}, 'title', this.value)">
                            <h3 class="font-bold text-lg text-gray-800 view-only">${day.title}</h3>
                            <div class="text-xs text-gray-500">${day.date}</div>
                        </div>
                        <div class="text-right">
                            <span class="block text-xs text-gray-400">×™×•××™</span>
                            <span class="font-bold text-indigo-600">${formatPrice(dailyTotal)}</span>
                        </div>
                        <button class="edit-only text-red-400" onclick="deleteDay(${dayIdx})">ğŸ—‘ï¸</button>
                    </div>
                    <div class="pl-2">${timelineHtml}</div>
                    <button class="edit-only w-full mt-2 text-xs border border-dashed border-gray-300 p-1 rounded text-gray-400" onclick="addTimelineItem(${dayIdx})">+ ×¤×¢×™×œ×•×ª</button>
                `;
                container.appendChild(card);
            });
        }

        // 2. Logistics Renderer (Generic for all groups)
        function renderLogisticsGroup(type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const groups = appData.logistics[type] || [];

            // Sort housing by date
            if(type === 'housing' || type === 'markets') {
                groups.sort((a,b) => (a.date || '').localeCompare(b.date || ''));
            }

            groups.forEach((group, gIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-white border border-gray-200 rounded-xl p-4 mb-4';
                
                // Header
                let header = `
                    <div class="flex justify-between mb-2">
                        <div class="w-full">
                            <input class="font-bold text-lg bg-transparent edit-only w-full" value="${group.title}" onchange="updateGroup('${type}', ${gIdx}, 'title', this.value)">
                            <h3 class="font-bold text-lg view-only flex items-center gap-2">
                                ${group.title} 
                                ${group.date ? `<span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 rounded">${group.date}</span>` : ''}
                            </h3>
                            ${isEditMode ? `<input type="date" value="${group.date || ''}" class="text-xs w-32 mb-2" onchange="updateGroup('${type}', ${gIdx}, 'date', this.value)">` : ''}
                        </div>
                        <button class="edit-only text-red-400" onclick="deleteGroup('${type}', ${gIdx})">ğŸ—‘ï¸</button>
                    </div>
                `;

                // Options logic
                let optionsHtml = '';
                group.options.forEach((opt, oIdx) => {
                    const isSelected = group.selectedId === opt.id;
                    const bookedBadge = opt.booked ? `<span class="badge-booked">×”×•×–××Ÿ</span>` : '';
                    
                    // View Mode: Click to select (if alternatives exist)
                    // Edit Mode: Full edit form
                    
                    if (isEditMode) {
                        optionsHtml += `
                            <div class="option-card ${isSelected ? 'selected' : ''} p-3 relative">
                                <div class="absolute top-2 left-2 flex gap-2">
                                    <input type="radio" name="grp-${type}-${gIdx}" ${isSelected ? 'checked' : ''} onchange="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                    <button class="text-red-400 text-xs" onclick="deleteOption('${type}', ${gIdx}, ${oIdx})">x</button>
                                </div>
                                <input class="font-bold text-sm mb-1" value="${opt.name}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'name', this.value)">
                                <textarea class="text-xs mb-1" rows="2" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'desc', this.value)">${opt.desc}</textarea>
                                <div class="flex gap-2 mb-1">
                                    <input type="number" class="w-20 text-xs" value="${opt.cost}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'cost', this.value)">
                                    <input type="text" class="flex-1 text-xs" placeholder="×œ×™× ×§" value="${opt.link || ''}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'link', this.value)">
                                </div>
                                <div class="flex gap-2 items-center bg-gray-50 p-1 rounded">
                                    <label class="text-xs flex items-center gap-1"><input type="checkbox" ${opt.booked ? 'checked' : ''} onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'booked', this.checked)"> ×”×•×–××Ÿ</label>
                                    <input class="text-xs flex-1" placeholder="×¤×¨×˜×™ ×”×–×× ×”" value="${opt.info || ''}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'info', this.value)">
                                </div>
                            </div>
                        `;
                    } else {
                        // View Mode - Show all options, highlight selected. Allow clicking to swap.
                        optionsHtml += `
                            <div class="option-card ${isSelected ? 'selected' : ''} flex justify-between items-center p-3" onclick="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                <div>
                                    <div class="font-bold text-sm flex items-center gap-2">
                                        ${opt.name} 
                                        ${bookedBadge}
                                        ${isSelected ? '<span class="text-indigo-600 text-xs border border-indigo-200 px-1 rounded">× ×‘×—×¨</span>' : ''}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">${opt.desc}</div>
                                    ${opt.link ? `<a href="${opt.link}" target="_blank" class="text-xs text-blue-500 underline mt-1 block" onclick="event.stopPropagation()">×§×™×©×•×¨ ×œ×”×–×× ×”</a>` : ''}
                                    ${opt.booked && opt.info ? `<div class="text-xs bg-green-50 text-green-800 p-1 mt-1 rounded border border-green-100">${opt.info}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-indigo-700">${formatPrice(opt.cost)}</div>
                                </div>
                            </div>
                        `;
                    }
                });

                wrapper.innerHTML = header + `<div class="space-y-2">${optionsHtml}</div>` + (isEditMode ? `<button class="w-full text-xs border border-dashed p-1 mt-2 text-gray-400" onclick="addOption('${type}', ${gIdx})">+ ×”×•×¡×£ ××•×¤×¦×™×”</button>` : '');
                container.appendChild(wrapper);
            });
        }

        // 3. Checklist Renderer
        function renderChecklist() {
            const tbody = document.getElementById('checklist-table-body');
            tbody.innerHTML = '';
            
            appData.checklist.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                
                const statusCell = `
                    <td class="px-2 py-3">
                        <input type="checkbox" class="w-5 h-5 accent-indigo-600 cursor-pointer" ${item.gotIt ? 'checked' : ''} onchange="updateChecklist(${idx}, 'gotIt', this.checked)">
                    </td>
                `;
                
                const nameCell = `
                    <td class="px-2 py-3 font-medium text-gray-900">
                        <span class="view-only ${item.gotIt ? 'line-through text-gray-400' : ''}">${item.text}</span>
                        <input class="edit-only" value="${item.text}" onchange="updateChecklist(${idx}, 'text', this.value)">
                    </td>
                `;
                
                const sourceCell = `
                    <td class="px-2 py-3 text-xs">
                        <span class="view-only">${item.source || '-'}</span>
                        <input class="edit-only" value="${item.source || ''}" placeholder="××§×•×¨" onchange="updateChecklist(${idx}, 'source', this.value)">
                    </td>
                `;
                
                const costCell = `
                    <td class="px-2 py-3 font-bold text-indigo-600">
                        <span class="view-only">${formatPrice(item.cost)}</span>
                        <input type="number" class="edit-only w-20" value="${item.cost}" onchange="updateChecklist(${idx}, 'cost', this.value)">
                    </td>
                `;
                
                const actionsCell = `
                    <td class="px-2 py-3 edit-only">
                        <button class="text-red-400" onclick="deleteChecklist(${idx})">ğŸ—‘ï¸</button>
                    </td>
                `;

                tr.innerHTML = statusCell + nameCell + sourceCell + costCell + actionsCell;
                tbody.appendChild(tr);
            });
        }

        // 4. Budget Renderer
        function renderBudget() {
            let paidTotal = 0;
            let futureTotal = 0;
            
            // Helper to process item cost
            const processCost = (cost, isBooked) => {
                const val = parseInt(cost || 0);
                if(isBooked) paidTotal += val;
                else futureTotal += val;
                return val;
            };

            // Days
            appData.days.forEach(d => {
                d.timeline.forEach(t => processCost(t.cost, t.booked));
            });

            // Logistics (Only selected options count!)
            ['flights', 'housing', 'cars', 'markets'].forEach(type => {
                (appData.logistics[type] || []).forEach(group => {
                    const selected = group.options.find(o => o.id === group.selectedId);
                    if(selected) processCost(selected.cost, selected.booked);
                });
            });

            // Checklist
            appData.checklist.forEach(c => processCost(c.cost, c.gotIt));

            // Update UI
            document.getElementById('total-paid').textContent = formatPrice(paidTotal);
            document.getElementById('total-future').textContent = formatPrice(futureTotal);
            document.getElementById('total-sum').textContent = formatPrice(paidTotal + futureTotal);

            // Chart
            const ctx = document.getElementById('budgetChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['×©×•×œ×/×”×•×–××Ÿ', '×¢×ª×™×“×™'],
                    datasets: [{
                        data: [paidTotal, futureTotal],
                        backgroundColor: ['#4ade80', '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- ACTIONS ---
        
        // Timeline
        window.addDay = () => { appData.days.push({id: Date.now(), date: '×ª××¨×™×š', title: '×™×•× ×—×“×©', timeline: []}); saveData(); renderAll(); }
        window.deleteDay = (idx) => { if(confirm('×œ××—×•×§?')) { appData.days.splice(idx, 1); saveData(); renderAll(); } }
        window.updateDay = (idx, field, val) => { appData.days[idx][field] = val; saveData(); renderAll(); }
        
        window.addTimelineItem = (dIdx) => { appData.days[dIdx].timeline.push({time:'12:00', title:'×¤×¢×™×œ×•×ª', desc:'', cost:0, booked:false}); saveData(); renderAll(); }
        window.deleteTimelineItem = (dIdx, tIdx) => { appData.days[dIdx].timeline.splice(tIdx, 1); saveData(); renderAll(); }
        window.updateTimeline = (dIdx, tIdx, field, val) => { appData.days[dIdx].timeline[tIdx][field] = val; saveData(); renderAll(); }
        window.showTimelineDetails = (dIdx, tIdx) => {
            if(isEditMode) return;
            const item = appData.days[dIdx].timeline[tIdx];
            const content = `
                <div class="font-bold text-xl mb-2 text-indigo-900">${item.title}</div>
                <div class="bg-gray-100 p-2 rounded mb-4 font-mono text-sm">${item.time} | ${dayData.date}</div>
                <p class="mb-4">${item.desc || '××™×Ÿ ×ª×™××•×¨'}</p>
                <div class="border-t pt-4">
                    <div class="flex justify-between mb-2">
                        <span>×¢×œ×•×ª:</span>
                        <span class="font-bold">${formatPrice(item.cost)}</span>
                    </div>
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                        <span>×¡×˜×˜×•×¡:</span>
                        ${item.booked ? '<span class="badge-booked">×”×•×–××Ÿ âœ…</span>' : '<span class="text-gray-500">×˜×¨× ×”×•×–××Ÿ</span>'}
                    </div>
                    ${item.booked && item.info ? `<div class="mt-4 bg-green-50 p-3 rounded border border-green-100 text-sm"><div class="font-bold text-green-800 mb-1">×¤×¨×˜×™ ×”×–×× ×”:</div>${item.info}</div>` : ''}
                </div>
            `;
            // Getting day date for context
            const dayData = appData.days[dIdx];
            document.getElementById('modal-content').innerHTML = content.replace('undefined', dayData.date); // fix date ref
            document.getElementById('details-modal').classList.remove('hidden');
            document.getElementById('details-modal').classList.add('flex');
        }

        // Logistics Groups
        window.addGroup = (type) => { 
            if(!appData.logistics[type]) appData.logistics[type] = [];
            const newId = 'opt' + Date.now();
            appData.logistics[type].push({ id: Date.now(), title: '×—×“×©', date: '', options: [{id: newId, name:'××•×¤×¦×™×” 1', cost:0, booked:false}], selectedId: newId });
            saveData(); renderAll(); 
        }
        window.deleteGroup = (type, idx) => { if(confirm('×œ××—×•×§?')) { appData.logistics[type].splice(idx, 1); saveData(); renderAll(); } }
        window.updateGroup = (type, idx, field, val) => { appData.logistics[type][idx][field] = val; saveData(); renderAll(); }
        
        // Options
        window.addOption = (type, gIdx) => {
            const newId = 'opt' + Date.now();
            appData.logistics[type][gIdx].options.push({ id: newId, name: '××•×¤×¦×™×” ×—×“×©×”', cost: 0, booked: false });
            saveData(); renderAll();
        }
        window.deleteOption = (type, gIdx, oIdx) => {
            const group = appData.logistics[type][gIdx];
            const optId = group.options[oIdx].id;
            // Prevent deleting the only option or the selected one without logic handling
            if(group.options.length <= 1) return alert('×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª ××•×¤×¦×™×” ××—×ª');
            
            group.options.splice(oIdx, 1);
            if(group.selectedId === optId) group.selectedId = group.options[0].id; // Select first if deleted selected
            
            saveData(); renderAll();
        }
        window.updateOption = (type, gIdx, oIdx, field, val) => {
            appData.logistics[type][gIdx].options[oIdx][field] = val;
            saveData(); renderAll();
        }
        window.selectOption = (type, gIdx, optId) => {
            appData.logistics[type][gIdx].selectedId = optId;
            saveData(); renderAll(); // Re-render updates budget and UI highlighting
        }

        // Checklist
        window.addCheckItem = () => {
            const text = document.getElementById('new-item-text').value;
            const cost = document.getElementById('new-item-price').value;
            if(text) {
                appData.checklist.push({ id: Date.now(), text: text, cost: cost || 0, gotIt: false });
                document.getElementById('new-item-text').value = '';
                document.getElementById('new-item-price').value = '';
                saveData(); renderAll();
            }
        }
        window.updateChecklist = (idx, field, val) => { appData.checklist[idx][field] = val; saveData(); renderAll(); }
        window.deleteChecklist = (idx) => { appData.checklist.splice(idx, 1); saveData(); renderAll(); }

        // Global
        window.renderAll = () => {
            renderItinerary();
            renderLogisticsGroup('flights', 'flights-container');
            renderLogisticsGroup('housing', 'housing-container');
            renderLogisticsGroup('cars', 'cars-container');
            renderLogisticsGroup('markets', 'markets-container');
            renderChecklist();
            renderBudget();
        }

        async function saveData() {
            try { await updateDoc(tripRef, appData); } catch(e) { console.error(e); }
        }

        window.closeModal = () => {
            document.getElementById('details-modal').classList.add('hidden');
            document.getElementById('details-modal').classList.remove('flex');
        }

        // Init Logic
        const CORRECT_CODE = '8989';
        document.getElementById('login-btn').addEventListener('click', () => {
            if(document.getElementById('passcode-input').value === CORRECT_CODE) {
                document.getElementById('login-screen').style.display = 'none';
                initFirebaseListener();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        function initFirebaseListener() {
            onSnapshot(tripRef, async (docSnap) => {
                document.getElementById('loading-screen').style.display = 'none';
                if (docSnap.exists()) {
                    appData = docSnap.data();
                    // Ensure structure exists
                    if(!appData.logistics) appData.logistics = { flights: [], housing: [], cars: [], markets: [] };
                } else {
                    await setDoc(tripRef, appData); // Save initial structure if empty
                }
                renderAll();
            });
        }

    </script>
</body>
</html>
