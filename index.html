<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™ ğŸ³ï¸â€ğŸŒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #F0F2F5; color: #1F2937; -webkit-tap-highlight-color: transparent; }
        
        /* Modal & Overlay Animations */
        #day-modal { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        #day-modal.open { opacity: 1; pointer-events: auto; }
        .modal-content { transform: translateY(20px); transition: transform 0.3s ease; }
        #day-modal.open .modal-content { transform: translateY(0); }

        /* Mode Visibility inside Modal */
        .modal-view-mode .edit-field { display: none !important; }
        .modal-edit-mode .view-field { display: none !important; }
        
        /* Inputs */
        input, textarea, select { background: transparent; border: 1px solid transparent; border-bottom: 1px solid #D1D5DB; outline: none; transition: all 0.2s; width: 100%; border-radius: 4px; }
        .modal-edit-mode input, .modal-edit-mode textarea, .modal-edit-mode select { 
            background: #F9FAFB; border: 1px solid #D1D5DB; padding: 4px 8px; 
        }
        .modal-edit-mode input:focus, .modal-edit-mode textarea:focus { border-color: #4F46E5; ring: 2px solid #E0E7FF; }

        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .day-card { 
            background: white; border-radius: 16px; padding: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #E5E7EB;
            cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 200px; position: relative; overflow: hidden;
        }
        .day-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: #818CF8; }
        .day-card::after { content:''; position: absolute; bottom:0; right:0; width: 100%; height: 4px; background: linear-gradient(90deg, #4F46E5, #A5B4FC); }

        /* Detailed Timeline */
        .timeline-item { position: relative; padding-right: 40px; padding-bottom: 30px; border-right: 2px solid #E5E7EB; }
        .timeline-item:last-child { border-right: transparent; }
        .timeline-icon { 
            position: absolute; right: -21px; top: 0; width: 40px; height: 40px; 
            background: white; border: 2px solid #4F46E5; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Chips & Badges */
        .info-chip { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; margin-left: 4px; }
        .chip-price { background: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0; }
        .chip-dist { background: #EFF6FF; color: #1E40AF; border: 1px solid #BFDBFE; }
        .chip-warn { background: #FEF2F2; color: #991B1B; border: 1px solid #FECACA; }
        .booked-badge { background: #DCFCE7; color: #166534; font-size: 0.7rem; padding: 2px 6px; border-radius: 99px; border: 1px solid #86EFAC; }

        /* Sticky Note */
        .sticky-note { 
            background: #FEF3C7; color: #78350F; padding: 10px; border-radius: 0 8px 8px 8px; 
            font-family: 'Kalam', cursive; font-size: 0.9rem; border-left: 4px solid #F59E0B; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05); margin-top: 8px; position: relative;
        }
        .sticky-source { font-size: 0.65rem; color: #92400E; text-align: left; margin-top: 4px; font-family: sans-serif; opacity: 0.7; }

        /* Option Card */
        .option-card { border: 1px solid #E5E7EB; padding: 12px; border-radius: 10px; margin-bottom: 10px; transition: 0.2s; background: #fff; position: relative; }
        .option-card.selected { border: 2px solid #4F46E5; background: #EEF2FF; }
        .option-card:not(.selected):hover { border-color: #A5B4FC; }

        /* Tabs */
        .tab-btn { padding: 10px 20px; border-radius: 99px; color: #6B7280; font-weight: 600; transition: 0.2s; }
        .tab-btn.active { background: #4F46E5; color: white; shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* Loader */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-20">

    <!-- Loading & Login -->
    <div id="loading-screen"><div class="loader mb-4"></div><p class="text-gray-600 font-bold">××›×™×Ÿ ××ª ×”××¡×¢...</p></div>
    
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center w-96">
            <div class="text-5xl mb-4">ğŸ‘¬</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™</h2>
            <p class="text-gray-500 mb-6">×™× ×•××¨ 2026 | ×˜×¨×•××¡×•</p>
            <input type="password" id="passcode-input" placeholder="×§×•×“ ×’×™×©×”" class="w-full text-center text-2xl p-3 border-2 border-gray-200 rounded-xl mb-6 focus:border-indigo-500 tracking-widest">
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition transform hover:scale-105">×›× ×™×¡×” ×œ×™×•××Ÿ ××¡×¢</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden font-bold">×”×§×•×“ ×©×’×•×™, × ×¡×• ×©× ×™×ª</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-30 backdrop-blur-md bg-white/90">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">ğŸ‡³ğŸ‡´ ×˜×¨×•××¡×• 2026</h1>
                    <p class="text-xs text-gray-500">××ª×›× ×Ÿ ×˜×™×•×œ ×—×›×</p>
                </div>
                <div class="flex gap-3">
                    <button id="currency-btn" class="bg-gray-100 px-4 py-2 rounded-xl text-sm font-bold border border-gray-200 hover:bg-gray-200 transition" onclick="toggleCurrency()">
                        â‚ª <span class="text-gray-400 mx-1">|</span> â‚¬
                    </button>
                </div>
            </div>
            <nav class="flex overflow-x-auto gap-2 pb-1 no-scrollbar">
                <button class="tab-btn active" onclick="switchTab('itinerary')">ğŸ“… ×œ×•×— ××¡×¢</button>
                <button class="tab-btn" onclick="switchTab('logistics')">âœˆï¸ ×œ×•×’×™×¡×˜×™×§×”</button>
                <button class="tab-btn" onclick="switchTab('checklist')">ğŸ’ ×¦×™×•×“</button>
                <button class="tab-btn" onclick="switchTab('budget')">ğŸ’° ×ª×§×¦×™×‘</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto max-w-5xl p-4 mt-4">

        <!-- TAB 1: ITINERARY (CALENDAR GRID) -->
        <section id="itinerary" class="tab-content active">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">×¡×§×™×¨×” ×™×•××™×ª</h2>
                    <p class="text-sm text-gray-500">×œ×—×¦×• ×¢×œ ×™×•× ×œ×¤×™×¨×•×˜ ××œ× ×•×¢×¨×™×›×”</p>
                </div>
            </div>
            
            <div id="days-grid" class="calendar-grid">
                <!-- Cards injected via JS -->
            </div>
            
            <button class="w-full py-4 mt-8 border-2 border-dashed border-gray-300 text-gray-400 rounded-2xl font-bold hover:bg-white hover:border-indigo-300 transition flex items-center justify-center gap-2" onclick="addDay()">
                <i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×™×•× ×—×“×©
            </button>
        </section>

        <!-- TAB 2: LOGISTICS -->
        <section id="logistics" class="tab-content">
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Left Col -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="flex justify-between mb-4 items-center">
                            <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-plane mr-2 text-blue-500"></i> ×˜×™×¡×•×ª</h3>
                            <button class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold" onclick="addGroup('flights')">+ ×”×•×¡×£</button>
                        </div>
                        <div id="flights-container"></div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="flex justify-between mb-4 items-center">
                            <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-car mr-2 text-red-500"></i> ×¨×›×‘ ×©×›×•×¨</h3>
                            <button class="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full font-bold" onclick="addGroup('cars')">+ ×”×•×¡×£</button>
                        </div>
                        <div id="cars-container"></div>
                    </div>
                </div>

                <!-- Right Col -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="flex justify-between mb-4 items-center">
                            <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-bed mr-2 text-indigo-500"></i> ×œ×™× ×”</h3>
                            <button class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full font-bold" onclick="addGroup('housing')">+ ×”×•×¡×£</button>
                        </div>
                        <div id="housing-container"></div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <div class="flex justify-between mb-4 items-center">
                            <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-cart-shopping mr-2 text-green-500"></i> ×¡×•×¤×¨××¨×§×˜×™×</h3>
                            <button class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-full font-bold" onclick="addGroup('markets')">+ ×”×•×¡×£</button>
                        </div>
                        <div id="markets-container"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB 3: CHECKLIST -->
        <section id="checklist" class="tab-content">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">×¨×©×™××ª ×¦×™×•×“ ×—×•×¨×£ (× ×‘×“×§!)</h2>
                
                <div class="bg-indigo-50 p-4 rounded-xl mb-6 flex gap-3 items-center">
                    <input type="text" id="new-item-text" placeholder="×©× ×”×¤×¨×™×˜..." class="bg-white border-0 rounded-lg px-4 py-3 flex-1 shadow-sm">
                    <input type="text" id="new-item-source" placeholder="××™×¤×” ×§×•× ×™×?" class="bg-white border-0 rounded-lg px-4 py-3 w-1/4 shadow-sm hidden md:block">
                    <input type="number" id="new-item-price" placeholder="××—×™×¨" class="bg-white border-0 rounded-lg px-4 py-3 w-24 shadow-sm">
                    <button onclick="addCheckItem()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700 transition">+</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-50 text-gray-700 uppercase text-xs rounded-lg">
                            <tr>
                                <th class="px-4 py-3 text-right rounded-r-lg">×¡×˜×˜×•×¡</th>
                                <th class="px-4 py-3 text-right">×¤×¨×™×˜</th>
                                <th class="px-4 py-3 text-right">××§×•×¨</th>
                                <th class="px-4 py-3 text-right">×¢×œ×•×ª</th>
                                <th class="px-4 py-3 rounded-l-lg"></th>
                            </tr>
                        </thead>
                        <tbody id="checklist-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TAB 4: BUDGET -->
        <section id="budget" class="tab-content">
            <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">× ×™×”×•×œ ×ª×§×¦×™×‘</h2>
                
                <div class="grid md:grid-cols-2 gap-12 items-center">
                    <div class="relative">
                        <canvas id="budgetChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                            <span class="text-sm text-gray-400">×¡×”"×›</span>
                            <span id="chart-total" class="text-2xl font-bold text-gray-800">0</span>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between p-5 bg-green-50 rounded-2xl border border-green-100">
                            <div>
                                <span class="block text-sm font-bold text-green-600 mb-1">×©×•×œ× / ×”×•×–××Ÿ âœ…</span>
                                <span class="text-xs text-green-500">×™×¨×“ ××”×—×©×‘×•×Ÿ</span>
                            </div>
                            <span id="total-paid" class="text-3xl font-bold text-green-700">0</span>
                        </div>
                        <div class="flex items-center justify-between p-5 bg-gray-50 rounded-2xl border border-gray-200">
                            <div>
                                <span class="block text-sm font-bold text-gray-500 mb-1">×¦×¤×™ ×¢×ª×™×“×™ ğŸ•’</span>
                                <span class="text-xs text-gray-400">×ª×©×œ×•× ×‘××§×•×/×“×œ×§/××•×›×œ</span>
                            </div>
                            <span id="total-future" class="text-3xl font-bold text-gray-700">0</span>
                        </div>
                        <div class="pt-6 border-t border-dashed">
                            <div class="flex justify-between items-end">
                                <span class="text-gray-400 font-bold">×¡×”"×› ×›×œ×œ×™ ××©×•×¢×¨</span>
                                <span id="total-sum" class="text-4xl font-extrabold text-indigo-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- === DAY MODAL (THE CORE INTERFACE) === -->
    <div id="day-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeDayModal()"></div>
        
        <div class="modal-content bg-white w-full max-w-3xl max-h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col relative modal-view-mode" id="modal-inner">
            
            <!-- Sticky Header -->
            <div class="bg-indigo-600 p-6 text-white shrink-0 flex justify-between items-start shadow-lg z-10">
                <div class="w-full">
                    <!-- View Mode Header -->
                    <div class="view-field">
                        <div class="text-indigo-200 font-bold text-sm mb-1 flex items-center gap-2">
                            <span id="view-day-date"></span>
                            <span class="bg-indigo-500/50 px-2 py-0.5 rounded text-xs" id="view-day-cost"></span>
                        </div>
                        <h2 class="text-3xl font-extrabold" id="view-day-title"></h2>
                        <p class="text-indigo-100 text-sm mt-2 opacity-90" id="view-day-note"></p>
                    </div>

                    <!-- Edit Mode Header -->
                    <div class="edit-field w-full">
                        <input id="edit-day-date" class="bg-indigo-700/50 text-white placeholder-indigo-300 text-sm font-bold mb-2 w-32 rounded px-2" placeholder="×ª××¨×™×š">
                        <input id="edit-day-title" class="bg-indigo-700/50 text-white placeholder-indigo-300 text-2xl font-bold w-full mb-2 rounded px-2" placeholder="×›×•×ª×¨×ª">
                        <textarea id="edit-day-note" class="bg-indigo-700/50 text-white placeholder-indigo-300 text-sm w-full rounded px-2 h-16" placeholder="×¡×™×›×•× ×™×•××™..."></textarea>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2 ml-4">
                    <button onclick="closeDayModal()" class="text-white/70 hover:text-white text-xl bg-indigo-700/30 w-8 h-8 rounded-full flex items-center justify-center">&times;</button>
                    <button id="modal-edit-toggle" onclick="toggleModalEdit()" class="bg-white text-indigo-600 text-xs font-bold px-3 py-1.5 rounded-lg shadow hover:bg-indigo-50 transition mt-1 whitespace-nowrap">
                        âœï¸ ×¢×¨×•×š ×™×•×
                    </button>
                </div>
            </div>

            <!-- Scrollable Body -->
            <div class="overflow-y-auto flex-1 p-0 bg-gray-50">
                
                <!-- Timeline Container -->
                <div class="p-6 pb-20">
                    <div id="modal-timeline" class="space-y-0 relative pl-4 border-l-0">
                        <!-- Items injected here -->
                    </div>

                    <!-- Add Button (Edit Mode Only) -->
                    <div class="edit-field mt-8 text-center">
                        <button onclick="addTimelineItemToModal()" class="bg-white border-2 border-dashed border-gray-300 text-gray-500 px-6 py-3 rounded-xl font-bold hover:border-indigo-400 hover:text-indigo-600 transition w-full">
                            + ×”×•×¡×£ ×¤×¢×™×œ×•×ª ×—×“×©×”
                        </button>
                        <button onclick="deleteCurrentDay()" class="text-red-400 text-xs mt-4 underline">××—×§ ××ª ×”×™×•× ×›×•×œ×•</button>
                    </div>
                </div>
            </div>

            <!-- Edit Mode Footer (Save) -->
            <div class="edit-field absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] flex justify-end gap-3">
                <button onclick="toggleModalEdit()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">×‘×™×˜×•×œ</button>
                <button onclick="saveModalData()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700 transition">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-indicator" class="fixed bottom-4 left-4 bg-white shadow-lg border border-gray-100 px-4 py-2 rounded-full text-xs font-bold text-gray-500 z-50 flex items-center gap-2 transition-all">
        <div class="w-2 h-2 rounded-full bg-gray-300 animate-pulse" id="sync-dot"></div>
        <span id="sync-text">×××ª×™×Ÿ...</span>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBN9quYq8q01fOgDKliJ_IUq40F0askb_w", authDomain: "tromso-trip.firebaseapp.com", projectId: "tromso-trip", storageBucket: "tromso-trip.firebasestorage.app", messagingSenderId: "706076555674", appId: "1:706076555674:web:c7f3075199b975897fe223", measurementId: "G-976T7D2Q1Z" };

        let app, db, tripRef;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); tripRef = doc(db, "trips", "ofri_ami_v8_final_full"); } catch (e) { console.error(e); }

        // --- RICH DATA ---
        // Prices sourced from VisitTromso, Fjellheisen.no, RentalCars (Jan 2025 estimates), Lametayel.
        const defaultData = {
            currency: 'ILS',
            days: [
                { 
                    id: 1, date: '13/1 (×’\')', title: '× ×—×™×ª×” ×•×”×ª××¨×’× ×•×ª', note: '××™× ×‘× ×•×¨×‘×’×™×” ××¦×•×™× ×™× ××”×‘×¨×–, ××™×Ÿ ×¦×•×¨×š ×œ×§× ×•×ª ××™× ××™× ×¨×œ×™×™×. ××œ×›×•×”×•×œ ×™×§×¨ ×××•×“ - ×œ×§× ×•×ª ×‘×“×™×•×˜×™ ×¤×¨×™.', 
                    timeline: [
                        { time: '14:00', title: '×˜×™×¡×” ×œ-TOS', desc: 'SAS ×“×¨×š OSL. ×©×™××• ×œ×‘: ×œ×¢×™×ª×™× ×¦×¨×™×š ×œ××¡×•×£ ×›×‘×•×“×” ×‘××•×¡×œ×• ×•×œ×”×¤×§×™×“ ××—×“×© (×œ×‘×“×•×§ ×‘×“×œ×¤×§).', cost: 0, booked: true, info: 'PNR: SK123', distance: '', warning: '×§×•× ×§×©×™×™×Ÿ ×§×¦×¨ ×‘××•×¡×œ×•', type: 'flight', note: '×œ×”×•×¨×™×“ ×¡×¨×˜×™× ×œ×˜×™×¡×”' },
                        { time: '18:00', title: '××™×¡×•×£ ×¨×›×‘', desc: 'Hertz ×‘×©×“×”. ×—×•×‘×” ×œ×‘×“×•×§ ×©××’×‘×™× ×ª×§×™× ×™× ×•×©×™×© ××’×¨×“ ×§×¨×—. ×”×¨×›×‘ ××’×™×¢ ×¢× ×¦××™×’×™ ×—×•×¨×£ (××¡××¨×™×).', cost: 0, booked: true, info: 'Voucher #555', distance: '×‘×©×“×”', warning: '×œ×¦×œ× ××ª ×”×¨×›×‘ ××›×œ ×›×™×•×•×Ÿ', type: 'car', note: '' },
                        { time: '19:30', title: 'REMA 1000 KvalÃ¸ysletta', desc: '×”×¡×•×¤×¨××¨×§×˜ ×”×›×™ ×–×•×œ ×•×’×“×•×œ ×‘×™×¦×™××” ××”×¢×™×¨ ×œ×›×™×•×•×Ÿ KvalÃ¸ya. ×”×¦×˜×™×™×“×•×ª ×œ×™×•××™×™×.', cost: 600, booked: false, info: '', distance: '7 ×“×§×•×ª × ×¡×™×¢×” ××”×©×“×”', warning: '× ×¡×’×¨ ×‘-23:00', type: 'food', note: '×œ×§× ×•×ª: ×’×‘×™× ×ª ×‘×¨×™, ×œ×—×, ×¤×¡×˜×”, ×¨×˜×‘×™×, × ×©× ×•×©×™×' },
                        { time: '20:30', title: '×¦\'×§ ××™×Ÿ Airbnb', desc: 'Ersfjordbotn. ×‘×§×ª×” ×¢×œ ×”××™×. ××–×•×¨ ×—×©×•×š ××¢×•×œ×” ×œ×–×•×”×¨ ××”××¨×¤×¡×ª.', cost: 0, booked: true, info: '×§×•×“ 1234', distance: '15 ×“×§×•×ª ××”×¡×•×¤×¨', warning: '', type: 'home', note: '××§×•×¨: ×”××œ×¦×ª ×’×•×œ×©×™× ×œ××˜×™×™×œ 2023' }
                    ]
                },
                { 
                    id: 2, date: '14/1 (×“\')', title: '×”×¢×™×¨ ×˜×¨×•××¡×•', note: '×™×•× ×¨×’×•×¢ ×‘×¢×™×¨. ×œ×”×ª×œ×‘×© ×‘×©×™×˜×ª ×”×‘×¦×œ - ×—× ×‘×¤× ×™×, ×§×¤×•× ×‘×—×•×¥.',
                    timeline: [
                        { time: '10:00', title: '×—× ×™×” ×‘××¨×›×– (Fjellet P-hus)', desc: '×—× ×™×” ××—×•×××ª ×‘×ª×•×š ×”×”×¨! ×—×•×•×™×” ×‘×¤× ×™ ×¢×¦××”. ×™×¦×™××•×ª ×¨×’×œ×™×•×ª ×œ××¨×›×– ×”×¢×™×¨.', cost: 120, booked: false, info: '', distance: '25 ×“×§×•×ª × ×¡×™×¢×”', warning: '×—×•×‘×” ××¤×œ×™×§×¦×™×™×ª EasyPark', type: 'car', note: '×œ× ×œ×—× ×•×ª ×‘×¨×—×•×‘ - ×™×§×¨ ×•××•×’×‘×œ ×‘×–××Ÿ' },
                        { time: '11:30', title: '×¨×›×‘×œ Fjellheisen', desc: '×ª×¦×¤×™×ª ××¨×”×™×‘×”. ×‘×—×•×¨×£ ×”×©××© ×œ× ×¢×•×œ×”, ××‘×œ ×™×© "×©×¢×•×ª ×“××“×•××™×" (Blue Hour) ××“×”×™××•×ª ×‘×™×Ÿ 10:00-13:00.', cost: 260, booked: false, info: '', distance: '×œ×—×¦×•×ª ××ª ×”×’×©×¨', warning: '×× ××¢×•× ×Ÿ ×××•×“ - ×œ×•×•×ª×¨', type: 'attraction', note: '××¤×©×¨ ×œ×©×ª×•×ª ×©×•×§×• ×—× ×œ××¢×œ×”' },
                        { time: '14:00', title: 'Rakettkiosken', desc: '×”× ×§× ×™×§×™×™×” ×”××¤×•×¨×¡××ª ×‘×›×™×›×¨ ×”××¨×›×–×™×ª. ××•×¡×“ ×§×•×œ×™× ×¨×™ ××§×•××™ ×•×–×•×œ.', cost: 80, booked: false, info: '', distance: '×‘××¨×›×–', warning: '', type: 'food', note: '×œ× ×¡×•×ª ××ª × ×§× ×™×§×™×™×ª ×”××™×™×œ' },
                        { time: '15:30', title: '×¡×¤×¨×™×™×ª ×˜×¨×•××¡×•', desc: '××‘× ×” ××“×¨×™×›×œ×™ ××“×”×™× ×¢× ×’×’ ×–×›×•×›×™×ª. ××§×•× ×˜×•×‘ ×œ×”×ª×—××.', cost: 0, booked: false, info: '', distance: '××¨×—×§ ×”×œ×™×›×”', warning: '', type: 'attraction', note: '' },
                        { time: '20:00', title: '××¨×“×£ ×–×•×”×¨ ×¢×¦×××™', desc: '× ×¡×™×¢×” ×œ×—×•×£ GrÃ¸tfjord ××• ×—×–×¨×” ×œ-Ersfjordbotn. ××§×•××•×ª ×—×©×•×›×™× ×œ×œ× ×–×™×”×•× ××•×¨.', cost: 0, booked: false, info: '', distance: '40 ×“×§×•×ª × ×¡×™×¢×”', warning: '×œ×‘×“×•×§ ××¤×œ×™×§×¦×™×™×ª My Aurora Forecast', type: 'star', note: '×œ×”×‘×™× ×ª×¨××•×¡ ×¢× ×ª×”' }
                    ] 
                },
                { 
                    id: 3, date: '15/1 (×”\')', title: '×›×œ×‘×™× ×•×¡××•× ×”', note: '×™×•× ××§×˜×™×‘×™. ×œ×”×‘×™× ×‘×’×“ ×™× ×œ×¡××•× ×” (×›×Ÿ, ×‘×—×•×¨×£!).',
                    timeline: [
                        { time: '08:45', title: '××–×—×œ×•×ª ×›×œ×‘×™×', desc: 'TromsÃ¸ Villmarkssenter. × ×”×™×’×” ×¢×¦××™×ª ×‘××–×—×œ×ª (Self-drive). ×›×•×œ×œ ×‘×™×’×•×“ ×—× ×•××¨×•×—×”.', cost: 1900, booked: false, info: '', distance: '25 ×“×§×•×ª × ×¡×™×¢×”', warning: '×œ×”×–××™×Ÿ ×—×•×“×©×™×™× ××¨××©!', type: 'attraction', note: '×—×•×•×™×” ×©×œ ×¤×¢× ×‘×—×™×™×' },
                        { time: '14:00', title: '×× ×•×—×” ×‘×‘×§×ª×”', desc: '××§×œ×—×ª ×—××” ×•×× ×•×—×” ×œ×§×¨××ª ×”×¢×¨×‘.', cost: 0, booked: false, info: '', distance: '', warning: '', type: 'home', note: '' },
                        { time: '17:00', title: '×¡××•× ×ª Pust', desc: '×¡××•× ×” ×¦×¤×” ×‘× ××œ ×˜×¨×•××¡×•. ×—× ×‘×¤× ×™×, ×§×•×¤×¦×™× ×œ××™× ×”×§×¤×•××™× (3 ××¢×œ×•×ª). ××—×–×§ ××ª ×”××¢×¨×›×ª ×”×—×™×¡×•× ×™×ª!', cost: 400, booked: false, info: '', distance: '×‘××¨×›×– ×”×¢×™×¨', warning: '×”×–×× ×” ××¨××© ×—×•×‘×” ×‘××ª×¨ pust.io', type: 'attraction', note: '××§×•×¨: ×”××œ×¦×ª ×’×•×œ×©×™× ×œ××˜×™×™×œ' }
                    ]
                },
                { 
                    id: 4, date: '16/1 (×•\')', title: '×”××¢×‘×•×¨×ª ×œ×¡× ×™×”', note: '×™×•× ××¢×‘×¨. ×”× ×•×¤×™× ×‘×“×¨×š ×œ×¡× ×™×” ×”× ×”×™×¤×™× ×‘×™×•×ª×¨ ×‘×˜×™×•×œ.',
                    timeline: [
                        { time: '09:30', title: '× ×¡×™×¢×” ×œ-Brensholmen', desc: '× ×¡×™×¢×” × ×•×¤×™×ª ×“×¨×š ×”×—×•×£ ×”×“×¨×•××™ ×©×œ KvalÃ¸ya.', cost: 0, booked: false, info: '', distance: '×©×¢×” × ×¡×™×¢×” (55 ×§"×)', warning: '×›×‘×™×©×™× ×¦×¨×™× ×•×—×œ×§×™×', type: 'car', note: '' },
                        { time: '11:00', title: '××¢×‘×•×¨×ª ×œ-Botnhamn', desc: '××¢×‘×•×¨×ª ×§×¨×™×˜×™×ª. ×—×•×¡×›×ª 3 ×©×¢×•×ª × ×¡×™×¢×”. ×‘×—×•×¨×£ ×™×© ××¢×˜ ×”×¤×œ×’×•×ª.', cost: 150, booked: false, info: '', distance: '45 ×“×§×•×ª ×”×¤×œ×’×”', warning: '×œ×‘×“×•×§ ×‘×‘×•×§×¨ ×‘-Troms Reise ×× ××‘×•×˜×œ!', type: 'car', note: '×× ××‘×•×˜×œ - × ×•×¡×¢×™× ××¡×‘×™×‘ (3.5 ×©×¢×•×ª)' },
                        { time: '13:00', title: 'Tungeneset', desc: '×ª×¦×¤×™×ª "×©×™× ×™ ×”×©×˜×Ÿ". ×¡×œ×¢×™× ××©×•× × ×™× ×”×™×•×¨×“×™× ×œ×™×. ×¢××“×ª ×¦×™×œ×•× ×—×•×‘×”.', cost: 0, booked: false, info: '', distance: '×¢×œ ×›×‘×™×© 862', warning: '×”×¡×œ×¢×™× ×—×œ×§×™× ×××•×“', type: 'attraction', note: '' },
                        { time: '15:00', title: 'Mefjord Brygge', desc: '×¦\'×§ ××™×Ÿ ×‘××œ×•×Ÿ ×“×™×¨×•×ª ×‘×ª×•×š ×¤×™×•×¨×“ ×“×¨××˜×™.', cost: 0, booked: true, info: '', distance: 'Senja', warning: '', type: 'home', note: '×™×© ××¡×¢×“×” ×‘××§×•× ×× ×œ× ×¨×•×¦×™× ×œ×‘×©×œ' }
                    ]
                },
                { id: 5, date: '17/1 (×©\')', title: '×”××™ ×¡× ×™×”', note: '×”×˜×‘×¢ ×‘×©×™××•. ×¡× ×™×” ×¤×¨××™×ª ×™×•×ª×¨ ××˜×¨×•××¡×•. ×›××¢×˜ ×•××™×Ÿ ×—× ×•×™×•×ª.', timeline: [
                    { time: '10:00', title: 'Bergsbotn', desc: '××¨×¤×¡×ª ×ª×¦×¤×™×ª ×ª×œ×•×™×” ××¢×œ ×”×¤×™×•×¨×“. × ×•×£ ×¢×•×¦×¨ × ×©×™××”.', cost: 0, booked: false, info: '', distance: '20 ×“×§ × ×¡×™×¢×”', warning: '', type: 'attraction', note: '' },
                    { time: '12:00', title: 'Hamn i Senja', desc: '×›×¤×¨ ×“×™×™×’×™× ×”×™×¡×˜×•×¨×™. ××§×•× ×™×¤×” ×œ×¢×¦×™×¨×ª ×§×¤×”/×¦×”×¨×™×™×.', cost: 100, booked: false, info: '', distance: '', warning: '', type: 'food', note: '' },
                    { time: '20:00', title: '×–×•×”×¨ ×‘×—×•×©×š', desc: '×‘×¡× ×™×” ××™×Ÿ ×–×™×”×•× ××•×¨. ×¤×©×•×˜ ×¦××• ××”××¨×¤×¡×ª ××• ×¡×¢×• ×œ×—×•×£ ×—×©×•×š.', cost: 0, booked: false, info: '', distance: '', warning: '', type: 'star', note: '×¡×™×›×•×™ ×’×‘×•×” ×™×•×ª×¨ ××˜×¨×•××¡×•' }
                ] },
                { id: 6, date: '18/1 (×\')', title: '×—×–×¨×” ×œ×˜×¨×•××¡×•', note: '×™×•× ×¨××©×•×Ÿ - ×¨×•×‘ ×”×—× ×•×™×•×ª ×¡×’×•×¨×•×ª.', timeline: [
                    { time: '10:00', title: '×™×¦×™××” ××¡× ×™×”', desc: '×“×¨×š ×”××¢×‘×•×¨×ª ××• ×”×™×‘×©×” (×ª×œ×•×™ ×‘××–×’ ××•×•×™×¨).', cost: 0, booked: false, info: '', distance: '', warning: '', type: 'car', note: '' },
                    { time: '14:00', title: 'SommarÃ¸y', desc: '"××™ ×”×§×™×¥". ×—×•×¤×™× ×œ×‘× ×™× ××¨×§×˜×™×™× ×•××™ ×˜×•×¨×§×™×–. ×¡×™×‘×•×‘ ×¨×’×œ×™ ×§×¦×¨.', cost: 0, booked: false, info: '', distance: '', warning: '×¨×•×—×•×ª ×—×–×§×•×ª ×‘×“"×›', type: 'attraction', note: '' },
                    { time: '19:00', title: 'Ã˜lhallen Pub', desc: '×”×¤××‘ ×”×•×•×ª×™×§ ×‘×˜×¨×•××¡×•. 72 ×¡×•×’×™ ×‘×™×¨×” ××”×—×‘×™×ª. ××•×•×™×¨×” ××§×•××™×ª.', cost: 150, booked: false, info: '', distance: '××¨×›×– ×”×¢×™×¨', warning: '× ×¡×’×¨ ××•×§×“× ×‘×™×•× ×\'', type: 'food', note: '××§×•×¨: ×”××œ×¦×ª ×’×•×œ×©×™×' }
                ] },
                { id: 7, date: '19/1 (×‘\')', title: '×¤×¨×™×“×”', note: '', timeline: [
                    { time: '11:00', title: '×§× ×™×•×ª ××–×›×¨×•×ª', desc: '×¨×—×•×‘ Storgata. ×¡×•×•×“×¨×™× × ×•×¨×‘×’×™×™×, ×˜×¨×•×œ×™× ×•×’×‘×™× ×” ×—×•××”.', cost: 400, booked: false, info: '', distance: '', warning: '', type: 'attraction', note: '' },
                    { time: '13:00', title: 'Polaria', desc: '××§×•×•×¨×™×•× ××¨×§×˜×™. ×”××›×œ×ª ×›×œ×‘×™ ×™× ×‘-12:30 ××• 15:30. ×¡×¨×˜ ×¤× ×•×¨××™ ×™×¤×”.', cost: 300, booked: false, info: '', distance: '', warning: '', type: 'attraction', note: '' },
                    { time: '19:00', title: 'Fiskekompaniet', desc: '××¨×•×—×ª ×¢×¨×‘ ×—×’×™×’×™×ª ×œ×¡×™×•×. ××¡×¢×“×ª ×“×’×™× ×•×¤×™×¨×•×ª ×™× ×”×˜×•×‘×” ×‘×¢×™×¨.', cost: 800, booked: false, info: '', distance: '×¢×œ ×”× ××œ', warning: '×œ×”×–××™×Ÿ ××§×•× ×©×‘×•×¢ ××¨××©', type: 'food', note: '×™×§×¨ ××‘×œ ×©×•×•×”' }
                ] },
                { id: 8, date: '20/1 (×’\')', title: '×˜×™×¡×” ×œ-AMS', note: '×™×•× × ×¡×™×¢×•×ª.', timeline: [
                    { time: '10:00', title: '×”×—×–×¨×ª ×¨×›×‘', desc: '×‘×©×“×” ×”×ª×¢×•×¤×” TOS. ×œ××œ× ×“×œ×§ ×œ×¤× ×™!', cost: 300, booked: false, info: '', distance: '', warning: '×ª×—× ×ª ×“×œ×§ ×œ×™×“ ×”×©×“×”', type: 'car', note: '' },
                    { time: '18:00', title: '××œ×•×Ÿ ×‘×©×“×”', desc: 'CitizenM Schiphol. ×”×œ×™×›×” ×‘×¨×’×œ ××”×˜×¨××™× ×œ.', cost: 900, booked: true, info: '', distance: '', warning: '', type: 'home', note: '×—×“×¨×™× ×§×˜× ×™× ××š ××•×“×¨× ×™×™×' }
                ] }
            ],
            logistics: {
                flights: [
                    { id: 'f1', title: '×˜×™×¡×•×ª (×œ×¤×™ ×œ××˜×™×™×œ)', options: [
                        { id: 'o1', name: 'SAS + Norwegian', desc: '×”×œ×•×š ×‘-13/1, ×—×–×•×¨ ×‘-20/1', cost: 3500, booked: true, info: '×”×•×–××Ÿ' }
                    ], selectedId: 'o1' }
                ],
                housing: [
                    { id: 'h1', title: '×˜×¨×•××¡×• (×œ×™×œ×•×ª 1-3)', date:'2026-01-13', options: [
                        { id: 'opt1', name: 'Airbnb Ersfjord', desc: '××•××œ×¥ ×œ×–×•×”×¨', cost: 3200, booked: true, info: '' },
                        { id: 'opt2', name: 'Clarion The Edge', desc: '×‘××¨×›×–', cost: 4000, booked: false, info: '' }
                    ], selectedId: 'opt1' },
                    { id: 'h2', title: '×¡× ×™×” (×œ×™×œ×•×ª 4-5)', date:'2026-01-16', options: [
                        { id: 'opt1', name: 'Mefjord Brygge', desc: '×“×™×¨×” ×‘×¤×™×•×¨×“', cost: 2400, booked: false, info: '' }
                    ], selectedId: 'opt1' }
                ],
                cars: [
                    { id: 'c1', title: '×¨×›×‘', options: [
                        { id: 'o1', name: 'Hertz (×©×“×”)', desc: 'Toyota RAV4 4x4', cost: 4500, booked: false, info: '' },
                        { id: 'o2', name: 'Rent-A-Wreck', desc: '××©×•××© ×•×–×•×œ (××•× ×™×ª ×œ×¡× ×™×£)', cost: 2800, booked: false, info: '' }
                    ], selectedId: 'o1' }
                ],
                markets: [
                    { id: 'm1', title: '×¡×•×¤×¨××¨×§×˜ ×¨××©×™', options: [{id:'o1', name:'REMA 1000', desc:'×”×›×™ ×–×•×œ', cost:800, booked:false}], selectedId:'o1' }
                ]
            },
            checklist: [
                { id: 1, text: '×‘×™×’×•×“ ×ª×¨××™ (××¨×™× ×•)', source: '×“×§×˜×œ×•×Ÿ', cost: 400, gotIt: true },
                { id: 2, text: '×§×¨××¤×•× ×™× (×“×•×§×¨× ×™×)', source: '×××–×•×Ÿ', cost: 100, gotIt: false },
                { id: 3, text: '×©×§×™×•×ª ×—×™××•×', source: '×¨×™×§×•×©×˜', cost: 50, gotIt: false }
            ]
        };

        // Declare appData here so it's available globally in the module scope
        let appData = defaultData;

        let isEditMode = false;
        let currentCurrency = 'ILS';
        let currentOpenDayIndex = -1;
        let modalEditMode = false; // New local state for modal
        const EUR_RATE = 4;
        const CACHE_KEY = 'tromso_v8_full_cache';

        // --- CORE FUNCTIONS ---
        const formatPrice = (ils) => currentCurrency === 'ILS' ? `â‚ª${parseInt(ils||0).toLocaleString()}` : `â‚¬${(parseInt(ils||0)/EUR_RATE).toFixed(0)}`;
        
        window.toggleModalEdit = () => {
            modalEditMode = !modalEditMode;
            const modal = document.getElementById('modal-inner');
            if (modalEditMode) {
                modal.classList.add('modal-edit-mode');
                modal.classList.remove('modal-view-mode');
                document.getElementById('modal-edit-toggle').textContent = '×‘×™×˜×•×œ ×¢×¨×™×›×”';
            } else {
                modal.classList.remove('modal-edit-mode');
                modal.classList.add('modal-view-mode');
                document.getElementById('modal-edit-toggle').textContent = 'âœï¸ ×¢×¨×•×š ×™×•×';
            }
        };

        // --- RENDERERS ---
        function renderGrid() {
            const container = document.getElementById('days-grid');
            container.innerHTML = '';
            appData.days.forEach((day, idx) => {
                let total = 0; day.timeline.forEach(t => total += parseInt(t.cost||0));
                const card = document.createElement('div');
                card.className = 'day-card';
                card.onclick = () => openDayModal(idx);
                card.innerHTML = `
                    <div>
                        <div class="text-indigo-500 font-bold text-xs uppercase mb-1 tracking-wide">${day.date}</div>
                        <h3 class="text-xl font-bold text-gray-800 leading-tight mb-2">${day.title}</h3>
                        <p class="text-sm text-gray-500 line-clamp-3 leading-relaxed">${day.note || '××™×Ÿ ×”×¢×¨×•×ª ××™×•×—×“×•×ª'}</p>
                    </div>
                    <div class="border-t pt-3 mt-auto flex justify-between items-end">
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-md font-medium">${day.timeline.length} ×¤×¢×™×œ×•×™×•×ª</span>
                        <span class="text-lg font-bold text-indigo-600">${formatPrice(total)}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.openDayModal = (idx) => {
            currentOpenDayIndex = idx;
            const day = appData.days[idx];
            modalEditMode = false; // Reset
            const modal = document.getElementById('modal-inner');
            modal.classList.remove('modal-edit-mode');
            modal.classList.add('modal-view-mode');
            document.getElementById('modal-edit-toggle').textContent = 'âœï¸ ×¢×¨×•×š ×™×•×';

            // Populate View
            document.getElementById('view-day-title').textContent = day.title;
            document.getElementById('view-day-date').textContent = day.date;
            document.getElementById('view-day-note').textContent = day.note;
            
            // Calculate Total for header
            let total = 0; day.timeline.forEach(t => total += parseInt(t.cost||0));
            document.getElementById('view-day-cost').textContent = formatPrice(total);

            // Populate Edit Inputs
            document.getElementById('edit-day-title').value = day.title;
            document.getElementById('edit-day-date').value = day.date;
            document.getElementById('edit-day-note').value = day.note || '';

            renderModalTimeline();
            const modalEl = document.getElementById('day-modal');
            modalEl.style.display = 'flex';
            setTimeout(() => modalEl.classList.add('open'), 10);
        };

        window.closeDayModal = () => {
            const modalEl = document.getElementById('day-modal');
            modalEl.classList.remove('open');
            setTimeout(() => modalEl.style.display = 'none', 300);
            currentOpenDayIndex = -1;
        };

        function renderModalTimeline() {
            const container = document.getElementById('modal-timeline');
            container.innerHTML = '';
            const day = appData.days[currentOpenDayIndex];

            day.timeline.forEach((item, tIdx) => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                // Icon Map
                const icons = { flight: 'âœˆï¸', car: 'ğŸš—', food: 'ğŸ”', home: 'ğŸ ', star: 'âœ¨', attraction: 'ğŸ“·', market: 'ğŸ›’' };
                const icon = icons[item.type] || 'ğŸ“';

                const bookedBadge = item.booked ? `<span class="booked-badge">×”×•×–××Ÿ</span>` : '';

                div.innerHTML = `
                    <div class="timeline-icon">${icon}</div>
                    
                    <!-- View Mode -->
                    <div class="view-field pl-2">
                        <div class="flex items-baseline gap-3 mb-1">
                            <span class="text-lg font-bold text-indigo-900 w-14 shrink-0">${item.time}</span>
                            <h4 class="text-lg font-bold text-gray-800">${item.title}</h4>
                        </div>
                        <p class="text-gray-600 mb-2 text-sm leading-relaxed">${item.desc}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${item.cost > 0 ? `<span class="info-chip chip-price">${formatPrice(item.cost)}</span>` : ''}
                            ${item.distance ? `<span class="info-chip chip-dist">ğŸš— ${item.distance}</span>` : ''}
                            ${bookedBadge}
                        </div>

                        ${item.warning ? `<div class="info-chip chip-warn w-full mb-1">âš ï¸ ${item.warning}</div>` : ''}
                        ${item.info ? `<div class="text-xs bg-blue-50 text-blue-700 p-2 rounded border border-blue-100 mb-1">â„¹ï¸ ×”×–×× ×”: ${item.info}</div>` : ''}
                        ${item.note ? `<div class="sticky-note">${item.note}<div class="sticky-source">××§×•×¨: ××—×§×¨/×œ××˜×™×™×œ</div></div>` : ''}
                    </div>

                    <!-- Edit Mode -->
                    <div class="edit-field bg-white border border-gray-200 p-4 rounded-xl shadow-sm space-y-3 relative">
                        <button onclick="deleteTimelineItem(${tIdx})" class="absolute top-2 left-2 text-red-400 hover:text-red-600 text-xs">ğŸ—‘ï¸ ××—×§</button>
                        <div class="flex gap-2">
                            <input type="time" value="${item.time}" class="w-24 font-bold" onchange="updateItem(${tIdx}, 'time', this.value)">
                            <input type="text" value="${item.title}" class="font-bold flex-1" placeholder="×›×•×ª×¨×ª" onchange="updateItem(${tIdx}, 'title', this.value)">
                            <select class="w-12" onchange="updateItem(${tIdx}, 'type', this.value)">
                                <option value="place" ${item.type==='place'?'selected':''}>ğŸ“</option>
                                <option value="flight" ${item.type==='flight'?'selected':''}>âœˆï¸</option>
                                <option value="car" ${item.type==='car'?'selected':''}>ğŸš—</option>
                                <option value="food" ${item.type==='food'?'selected':''}>ğŸ”</option>
                                <option value="home" ${item.type==='home'?'selected':''}>ğŸ </option>
                                <option value="star" ${item.type==='star'?'selected':''}>âœ¨</option>
                                <option value="attraction" ${item.type==='attraction'?'selected':''}>ğŸ“·</option>
                            </select>
                        </div>
                        <textarea rows="2" class="text-sm" placeholder="×ª×™××•×¨" onchange="updateItem(${tIdx}, 'desc', this.value)">${item.desc}</textarea>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" value="${item.cost}" placeholder="×¢×œ×•×ª" class="text-sm" onchange="updateItem(${tIdx}, 'cost', this.value)">
                            <input type="text" value="${item.distance}" placeholder="×–××Ÿ × ×¡×™×¢×”/××¨×—×§" class="text-sm" onchange="updateItem(${tIdx}, 'distance', this.value)">
                        </div>
                        <input type="text" value="${item.warning}" placeholder="âš ï¸ ××–×”×¨×”" class="text-sm text-red-600 bg-red-50 border-red-100" onchange="updateItem(${tIdx}, 'warning', this.value)">
                        <textarea rows="2" class="text-sm bg-yellow-50 border-yellow-200" placeholder="ğŸ“ ×¤×ª×§×™×ª/×˜×™×¤" onchange="updateItem(${tIdx}, 'note', this.value)">${item.note || ''}</textarea>
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border">
                            <input type="checkbox" class="w-4 h-4" ${item.booked ? 'checked' : ''} onchange="updateItem(${tIdx}, 'booked', this.checked)">
                            <span class="text-xs font-bold">×”×•×–××Ÿ?</span>
                            <input type="text" value="${item.info}" placeholder="×¤×¨×˜×™ ×”×–×× ×”" class="flex-1 text-xs" onchange="updateItem(${tIdx}, 'info', this.value)">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Save logic for Modal
        window.updateItem = (tIdx, field, val) => {
            appData.days[currentOpenDayIndex].timeline[tIdx][field] = val;
        };

        window.addTimelineItemToModal = () => {
            appData.days[currentOpenDayIndex].timeline.push({time:'12:00', title:'×¤×¢×™×œ×•×ª ×—×“×©×”', type:'place', cost:0});
            renderModalTimeline();
        };

        window.deleteTimelineItem = (tIdx) => {
            if(confirm('×œ××—×•×§?')) {
                appData.days[currentOpenDayIndex].timeline.splice(tIdx, 1);
                renderModalTimeline();
            }
        };

        window.deleteCurrentDay = () => {
            if(confirm('×œ××—×•×§ ××ª ×›×œ ×”×™×•× ×”×–×”?')) {
                appData.days.splice(currentOpenDayIndex, 1);
                saveData();
                closeDayModal();
                renderGrid();
            }
        };

        window.saveModalData = () => {
            const day = appData.days[currentOpenDayIndex];
            day.title = document.getElementById('edit-day-title').value;
            day.date = document.getElementById('edit-day-date').value;
            day.note = document.getElementById('edit-day-note').value;
            saveData();
            
            // Switch back to view mode locally without closing
            toggleModalEdit();
            
            // Update View Fields immediately
            document.getElementById('view-day-title').textContent = day.title;
            document.getElementById('view-day-date').textContent = day.date;
            document.getElementById('view-day-note').textContent = day.note;
            let total = 0; day.timeline.forEach(t => total += parseInt(t.cost||0));
            document.getElementById('view-day-cost').textContent = formatPrice(total);
            
            renderGrid(); // Update background grid
            renderModalTimeline(); // Re-render timeline (to remove inputs)
        };

        // --- OTHER TAB RENDERERS (Keep existing logic but cleaner) ---
        function renderLogisticsGroup(type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const groups = appData.logistics[type] || [];
            
            groups.forEach((group, gIdx) => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-xl p-4 mb-3 relative group';
                
                // Only show delete in Global Edit Mode
                const deleteBtn = isEditMode ? `<button onclick="deleteGroup('${type}', ${gIdx})" class="absolute top-2 left-2 text-red-400 hover:text-red-600">ğŸ—‘ï¸</button>` : '';
                
                let optionsHtml = '';
                group.options.forEach((opt, oIdx) => {
                    const selected = group.selectedId === opt.id;
                    const selectClass = selected ? 'selected' : '';
                    
                    // If NOT edit mode, allow clicking to select. If edit mode, show full inputs
                    if (isEditMode) {
                        optionsHtml += `
                            <div class="option-card ${selectClass} p-3 space-y-2">
                                <div class="flex gap-2 items-center">
                                    <input type="radio" name="grp-${type}-${gIdx}" ${selected ? 'checked' : ''} onchange="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                    <input class="font-bold text-sm flex-1" value="${opt.name}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'name', this.value)">
                                    <button class="text-red-400 text-xs" onclick="deleteOption('${type}', ${gIdx}, ${oIdx})">x</button>
                                </div>
                                <input class="text-xs" placeholder="×ª×™××•×¨" value="${opt.desc}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'desc', this.value)">
                                <input type="number" class="text-xs w-20" placeholder="××—×™×¨" value="${opt.cost}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'cost', this.value)">
                            </div>
                        `;
                    } else {
                        optionsHtml += `
                            <div class="option-card ${selectClass} flex justify-between items-center p-3 cursor-pointer hover:bg-gray-50" onclick="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                <div>
                                    <div class="font-bold text-sm flex items-center gap-2">
                                        ${opt.name} 
                                        ${opt.booked ? '<span class="booked-badge">×”×•×–××Ÿ</span>' : ''}
                                        ${selected ? '<span class="text-xs text-indigo-600 bg-indigo-50 px-2 rounded border border-indigo-100">× ×‘×—×¨</span>' : ''}
                                    </div>
                                    <div class="text-xs text-gray-500">${opt.desc}</div>
                                </div>
                                <div class="font-bold text-indigo-600">${formatPrice(opt.cost)}</div>
                            </div>
                        `;
                    }
                });

                card.innerHTML = `
                    ${deleteBtn}
                    <div class="flex justify-between items-center mb-2">
                        ${isEditMode ? `<input class="font-bold text-lg w-full" value="${group.title}" onchange="updateGroup('${type}', ${gIdx}, 'title', this.value)">` : `<h3 class="font-bold text-lg text-gray-800">${group.title} <span class="text-xs font-normal text-gray-400">${group.date||''}</span></h3>`}
                    </div>
                    <div class="space-y-2">${optionsHtml}</div>
                    ${isEditMode ? `<button class="text-xs border border-dashed p-1 mt-2 w-full text-gray-400" onclick="addOption('${type}', ${gIdx})">+ ××•×¤×¦×™×”</button>` : ''}
                `;
                container.appendChild(card);
            });
        }

        // --- BOILERPLATE & HELPERS ---
        window.addDay = () => { appData.days.push({id:Date.now(), date:'×ª××¨×™×š', title:'×™×•× ×—×“×©', timeline:[]}); saveData(); renderGrid(); }
        window.updateGroup = (t, i, f, v) => { appData.logistics[t][i][f] = v; saveData(); };
        window.deleteGroup = (t, i) => { if(confirm('?')) { appData.logistics[t].splice(i,1); saveData(); renderAll(); } };
        window.addGroup = (t) => { if(!appData.logistics[t]) appData.logistics[t]=[]; appData.logistics[t].push({id:Date.now(), title:'×—×“×©', options:[{id:'o'+Date.now(), name:'××•×¤×¦×™×” 1', cost:0}], selectedId:'o'+Date.now()}); saveData(); renderAll(); };
        window.updateOption = (t, g, o, f, v) => { appData.logistics[t][g].options[o][f] = v; saveData(); renderAll(); };
        window.selectOption = (t, g, id) => { appData.logistics[t][g].selectedId = id; saveData(); renderAll(); };
        window.addOption = (t, g) => { appData.logistics[t][g].options.push({id:'o'+Date.now(), name:'×—×“×©', cost:0}); saveData(); renderAll(); };
        window.deleteOption = (t, g, o) => { appData.logistics[t][g].options.splice(o,1); saveData(); renderAll(); };
        window.addCheckItem = () => { appData.checklist.push({id:Date.now(), text: document.getElementById('new-item-text').value, source: document.getElementById('new-item-source').value, cost: document.getElementById('new-item-price').value, gotIt: false}); saveData(); renderAll(); };
        window.updateChecklist = (i,f,v) => { appData.checklist[i][f]=v; saveData(); renderAll(); };
        window.deleteChecklist = (i) => { appData.checklist.splice(i,1); saveData(); renderAll(); };

        // Budget & Checklist Renderers (Simplified for brevity, similar to previous versions)
        function renderChecklist() {
            const t = document.getElementById('checklist-table-body'); t.innerHTML='';
            appData.checklist.forEach((c,i) => {
                t.innerHTML += `<tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3"><input type="checkbox" ${c.gotIt?'checked':''} onchange="updateChecklist(${i},'gotIt',this.checked)" class="w-5 h-5 accent-indigo-600"></td>
                    <td class="px-4 py-3">${isEditMode?`<input value="${c.text}" onchange="updateChecklist(${i},'text',this.value)">`:c.text}</td>
                    <td class="px-4 py-3 text-xs">${isEditMode?`<input value="${c.source||''}" onchange="updateChecklist(${i},'source',this.value)">`:c.source||'-'}</td>
                    <td class="px-4 py-3 font-bold text-indigo-600">${isEditMode?`<input type="number" class="w-20" value="${c.cost}" onchange="updateChecklist(${i},'cost',this.value)">`:formatPrice(c.cost)}</td>
                    <td class="px-4 py-3">${isEditMode?`<button class="text-red-400" onclick="deleteChecklist(${i})">ğŸ—‘ï¸</button>`:''}</td>
                </tr>`
            });
        }

        function renderBudget() {
            let paid=0, future=0;
            const sum = (c,b) => b ? paid+=parseInt(c||0) : future+=parseInt(c||0);
            appData.days.forEach(d=>d.timeline.forEach(t=>sum(t.cost,t.booked)));
            ['flights','housing','cars','markets'].forEach(t=>(appData.logistics[t]||[]).forEach(g=>{
                const s=g.options.find(o=>o.id===g.selectedId);
                if(s) sum(s.cost,s.booked);
            }));
            appData.checklist.forEach(c=>sum(c.cost,c.gotIt));
            
            document.getElementById('total-paid').textContent=formatPrice(paid);
            document.getElementById('total-future').textContent=formatPrice(future);
            document.getElementById('total-sum').textContent=formatPrice(paid+future);
            document.getElementById('chart-total').textContent=formatPrice(paid+future);

            const ctx = document.getElementById('budgetChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['×©×•×œ×','×¢×ª×™×“×™'], datasets: [{ data: [paid, future], backgroundColor: ['#22c55e', '#e5e7eb'], borderWidth:0 }] },
                options: { responsive:true, maintainAspectRatio:false, cutout: '70%', plugins: { legend: {display:false} } }
            });
        }

        // --- INIT ---
        
        async function saveData() {
            document.getElementById('sync-text').textContent = '×©×•××¨...';
            document.getElementById('sync-dot').className = 'w-2 h-2 rounded-full bg-yellow-400';
            try { 
                await updateDoc(tripRef, appData); 
                localStorage.setItem(CACHE_KEY, JSON.stringify(appData));
                document.getElementById('sync-text').textContent = '××¡×•× ×›×¨×Ÿ';
                document.getElementById('sync-dot').className = 'w-2 h-2 rounded-full bg-green-500';
            } catch(e) { console.error(e); }
        }

        window.renderAll = () => {
            renderGrid();
            renderLogisticsGroup('flights', 'flights-container');
            renderLogisticsGroup('housing', 'housing-container');
            renderLogisticsGroup('cars', 'cars-container');
            renderLogisticsGroup('markets', 'markets-container');
            renderChecklist();
            renderBudget();
        }

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        window.toggleCurrency = () => {
            currentCurrency = currentCurrency === 'ILS' ? 'EUR' : 'ILS';
            document.getElementById('currency-btn').innerHTML = currentCurrency === 'ILS' ? 'â‚ª | â‚¬' : 'â‚ª | <b>â‚¬</b>';
            renderAll();
        };

        window.toggleEditMode = () => {
            isEditMode = !isEditMode;
            document.body.classList.toggle('editing', isEditMode);
            document.getElementById('edit-btn').innerHTML = isEditMode ? 'âœ… ×¡×™×•×' : 'âœï¸ ×¢×¨×™×›×”';
            renderAll();
        };

        // Auth
        if (localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            const cached = localStorage.getItem(CACHE_KEY);
            if(cached) { appData = JSON.parse(cached); renderAll(); }
            onSnapshot(tripRef, (s) => {
                document.getElementById('loading-screen').style.display = 'none';
                if(s.exists()) { 
                    appData = s.data(); 
                    if(!appData.logistics) appData.logistics = {flights:[],housing:[],cars:[],markets:[]};
                    localStorage.setItem(CACHE_KEY, JSON.stringify(appData)); 
                    renderAll(); 
                } else { setDoc(tripRef, appData); }
            });
        } else {
            document.getElementById('loading-screen').style.display = 'none';
        }

        document.getElementById('login-btn').onclick = () => {
            if(document.getElementById('passcode-input').value === '8989') {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('login-screen').style.display = 'none';
                onSnapshot(tripRef, (s) => {
                    if(s.exists()) appData = s.data();
                    renderAll();
                });
            } else document.getElementById('login-error').classList.remove('hidden');
        };
    </script>
</body>
</html>
