<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™ ğŸ³ï¸â€ğŸŒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #F3F4F6; color: #1F2937; -webkit-tap-highlight-color: transparent; }
        
        /* Mode Visibility */
        body:not(.editing) .edit-only { display: none !important; }
        body.editing .view-only { display: none !important; }

        /* Custom Inputs */
        input, textarea, select { background: transparent; border-bottom: 1px solid #D1D5DB; outline: none; transition: border 0.3s; width: 100%; }
        body.editing input:focus, body.editing textarea:focus { border-bottom: 2px solid #4F46E5; background: #fff; }

        /* Day Card (Grid View) */
        .day-card { 
            background: white; border: 1px solid #E5E7EB; border-radius: 16px; padding: 20px; 
            cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between; height: 180px;
        }
        .day-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-color: #A5B4FC; }
        .day-card::before { content: ''; position: absolute; top: 0; right: 0; width: 6px; height: 100%; background: #4F46E5; }

        /* Detailed Timeline (Modal View) */
        .timeline-item { position: relative; padding-right: 30px; padding-bottom: 40px; border-right: 2px solid #E5E7EB; }
        .timeline-item:last-child { border-right: transparent; }
        .timeline-icon { 
            position: absolute; right: -20px; top: 0; width: 38px; height: 38px; 
            background: white; border: 2px solid #4F46E5; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; color: #4F46E5; font-weight: bold; z-index: 10;
        }
        
        /* Info Chips */
        .chip { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .chip-price { background: #ECFDF5; color: #047857; }
        .chip-dist { background: #EFF6FF; color: #1D4ED8; }
        .chip-warn { background: #FEF2F2; color: #B91C1C; border: 1px solid #FECACA; }
        .chip-tip { background: #FFFBEB; color: #B45309; border: 1px solid #FDE68A; }

        /* Modals */
        #day-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 4000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 700px; height: 90vh; border-radius: 20px; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        
        /* Loader & Login */
        #loading-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utilities */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        .tab-btn.active { color: #4F46E5; border-bottom: 2px solid #4F46E5; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-20">

    <!-- Loading & Login -->
    <div id="loading-screen"><div class="loader mb-4"></div><p class="text-gray-600 font-bold">×˜×•×¢×Ÿ ××ª ×”×˜×™×•×œ...</p></div>
    
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex flex-col items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-80">
            <div class="text-4xl mb-4">ğŸ‘¬</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">×”×˜×™×•×œ ×©×œ ×¢×¤×¨×™ ×•×¢××™</h2>
            <input type="password" id="passcode-input" placeholder="×”×–×Ÿ ×§×•×“" class="w-full text-center text-2xl p-3 border-2 border-gray-200 rounded-xl mb-4 focus:border-indigo-500">
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow hover:bg-indigo-700 transition">×›× ×™×¡×”</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">×§×•×“ ×©×’×•×™</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ‡³ğŸ‡´</span>
                    <h1 class="text-lg font-bold text-gray-800 leading-tight">×˜×¨×•××¡×• 2026<br><span class="text-xs text-gray-500 font-normal">×¢×¤×¨×™ & ×¢××™</span></h1>
                </div>
                <div class="flex gap-2">
                    <button id="currency-btn" class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-bold border border-gray-200" onclick="toggleCurrency()">â‚ª <span class="text-gray-300 mx-1">|</span> â‚¬</button>
                    <button id="edit-btn" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-sm font-bold border border-indigo-200" onclick="toggleEditMode()">âœï¸ ×¢×¨×™×›×”</button>
                </div>
            </div>
            <nav class="flex overflow-x-auto gap-6 text-sm font-medium text-gray-500 no-scrollbar border-b border-gray-100">
                <button class="tab-btn active whitespace-nowrap pb-2" onclick="switchTab('itinerary')">ğŸ“… ×œ×•×— ××¡×¢</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('logistics')">âœˆï¸ ×œ×•×’×™×¡×˜×™×§×”</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('checklist')">ğŸ’ ×¦×™×•×“</button>
                <button class="tab-btn whitespace-nowrap pb-2" onclick="switchTab('budget')">ğŸ’° ×ª×§×¦×™×‘</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4">

        <!-- TAB 1: ITINERARY GRID -->
        <section id="itinerary" class="tab-content active">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-gray-800">×¡×§×™×¨×” ×™×•××™×ª</h2>
                <span class="text-xs text-gray-500">×œ×—×¥ ×¢×œ ×™×•× ×œ×¤×™×¨×•×˜ ××œ×</span>
            </div>
            <div id="days-grid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <!-- Grid Cards Injected Here -->
            </div>
            <button class="edit-only w-full py-4 mt-6 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl font-bold hover:bg-white hover:border-indigo-300 transition" onclick="addDay()">+ ×”×•×¡×£ ×™×•× ×—×“×© ×œ×˜×™×•×œ</button>
        </section>

        <!-- TAB 2: LOGISTICS -->
        <section id="logistics" class="tab-content">
            <div class="space-y-8">
                <!-- Flights -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold text-lg">âœˆï¸ ×˜×™×¡×•×ª</h3>
                        <button class="edit-only text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded" onclick="addGroup('flights')">+ ×”×•×¡×£</button>
                    </div>
                    <div id="flights-container" class="space-y-3"></div>
                </div>
                <!-- Cars -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold text-lg">ğŸš— ×¨×›×‘ ×©×›×•×¨</h3>
                        <button class="edit-only text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded" onclick="addGroup('cars')">+ ×”×•×¡×£</button>
                    </div>
                    <div id="cars-container" class="space-y-3"></div>
                </div>
                <!-- Housing -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold text-lg">ğŸ  ×œ×™× ×”</h3>
                        <button class="edit-only text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded" onclick="addGroup('housing')">+ ×”×•×¡×£</button>
                    </div>
                    <div id="housing-container" class="space-y-3"></div>
                </div>
                <!-- Markets -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold text-lg">ğŸ›’ ×¡×•×¤×¨××¨×§×˜×™×</h3>
                        <button class="edit-only text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded" onclick="addGroup('markets')">+ ×”×•×¡×£</button>
                    </div>
                    <div id="markets-container" class="space-y-3"></div>
                </div>
            </div>
        </section>

        <!-- TAB 3: CHECKLIST -->
        <section id="checklist" class="tab-content">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-4">×¨×©×™××ª ×¦×™×•×“</h2>
                <div class="flex gap-2 mb-4 edit-only">
                    <input type="text" id="new-item-text" placeholder="×¤×¨×™×˜..." class="border rounded px-2 py-1 text-sm">
                    <input type="text" id="new-item-source" placeholder="××§×•×¨/×—× ×•×ª" class="border rounded px-2 py-1 text-sm">
                    <input type="number" id="new-item-price" placeholder="××—×™×¨" class="border rounded px-2 py-1 text-sm w-20">
                    <button onclick="addCheckItem()" class="bg-indigo-600 text-white px-3 rounded font-bold">+</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-50 text-gray-700 uppercase text-xs">
                            <tr>
                                <th class="px-2 py-3 text-right">V</th>
                                <th class="px-2 py-3 text-right">×¤×¨×™×˜</th>
                                <th class="px-2 py-3 text-right">××§×•×¨</th>
                                <th class="px-2 py-3 text-right">××—×™×¨</th>
                                <th class="px-2 py-3 edit-only"></th>
                            </tr>
                        </thead>
                        <tbody id="checklist-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TAB 4: BUDGET -->
        <section id="budget" class="tab-content">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h2 class="text-xl font-bold mb-6">×ª×§×¦×™×‘ ×”×˜×™×•×œ</h2>
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="h-64 flex justify-center w-full">
                        <canvas id="budgetChart"></canvas>
                    </div>
                    <div>
                        <div class="mb-4 p-4 bg-green-50 rounded-xl border border-green-100">
                            <span class="block text-sm font-bold text-green-600 mb-1">×©×•×œ× / ×”×•×–××Ÿ âœ…</span>
                            <span id="total-paid" class="text-3xl font-bold text-green-700">0</span>
                        </div>
                        <div class="mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <span class="block text-sm font-bold text-gray-500 mb-1">×¢×ª×™×“×™ / ×ª×©×œ×•× ×‘××§×•× ğŸ•’</span>
                            <span id="total-future" class="text-3xl font-bold text-gray-700">0</span>
                        </div>
                        <div class="pt-4 border-t flex justify-between items-center">
                            <span class="text-gray-400 font-bold">×¡×”"×› ×›×œ×œ×™</span>
                            <span id="total-sum" class="text-2xl font-bold text-indigo-600">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- DAY DETAILS MODAL (The Main Interaction) -->
    <div id="day-modal">
        <div class="modal-content">
            <!-- Header -->
            <div class="bg-indigo-600 p-6 text-white sticky top-0 z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <input id="modal-day-date" class="bg-transparent text-indigo-200 text-sm font-bold mb-1 edit-only" placeholder="×ª××¨×™×š">
                        <div id="view-day-date" class="text-indigo-200 text-sm font-bold mb-1 view-only"></div>
                        
                        <input id="modal-day-title" class="bg-transparent text-3xl font-bold w-full outline-none edit-only" placeholder="×›×•×ª×¨×ª ×”×™×•×">
                        <h2 id="view-day-title" class="text-3xl font-bold view-only"></h2>
                    </div>
                    <button onclick="closeDayModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="mt-4 flex gap-4 text-sm opacity-90">
                    <span>ğŸ’° <span id="modal-day-cost">0</span></span>
                    <button class="text-red-200 hover:text-white edit-only" onclick="deleteCurrentDay()">ğŸ—‘ï¸ ××—×§ ×™×•×</button>
                </div>
            </div>

            <!-- Body -->
            <div class="p-6 flex-1 bg-gray-50">
                <div id="modal-timeline-container" class="space-y-0">
                    <!-- Timeline Items Injected Here -->
                </div>
                
                <button class="edit-only w-full py-3 mt-6 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl font-bold hover:bg-white" onclick="addTimelineItemToModal()">+ ×”×•×¡×£ ×¤×¢×™×œ×•×ª ×œ×™×•× ×–×”</button>
                
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">×¡×™×›×•×/×”×¢×¨×•×ª ×œ×™×•×:</label>
                    <textarea id="modal-day-note" class="w-full bg-white p-3 rounded-xl border border-gray-200 text-sm h-24" placeholder="×”×¢×¨×•×ª ×›×œ×œ×™×•×ª..." onchange="saveModalData()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="sync-indicator" class="fixed bottom-4 left-4 bg-white shadow px-3 py-1 rounded-full text-xs font-bold text-gray-400 z-50 flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-gray-300" id="sync-dot"></div>
        <span id="sync-text">×××ª×™×Ÿ...</span>
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBN9quYq8q01fOgDKliJ_IUq40F0askb_w", authDomain: "tromso-trip.firebaseapp.com", projectId: "tromso-trip", storageBucket: "tromso-trip.firebasestorage.app", messagingSenderId: "706076555674", appId: "1:706076555674:web:c7f3075199b975897fe223", measurementId: "G-976T7D2Q1Z" };

        let app, db, tripRef;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); tripRef = doc(db, "trips", "ofri_ami_v4_final"); } catch (e) { console.error(e); }

        // --- RICH DATA STRUCTURE ---
        let appData = {
            currency: 'ILS',
            days: [
                { 
                    id: 1, date: '13/1 (×’\')', title: '× ×—×™×ª×” ×•×”×ª××¨×’× ×•×ª', note: '×œ×§× ×•×ª ××™×, ×¡×™× ××§×•××™ ×× ×¦×¨×™×š.', 
                    timeline: [
                        { time: '14:00', title: '×˜×™×¡×” ×œ-TOS', desc: 'SAS ×“×¨×š OSL. ×œ× ×—×•×ª ×‘×–××Ÿ!', cost: 0, booked: true, info: 'PNR: SK123', distance: '', warning: '×§×•× ×§×©×™×™×Ÿ ×§×¦×¨ ×‘××•×¡×œ×•', type: 'flight' },
                        { time: '18:00', title: '××™×¡×•×£ ×¨×›×‘', desc: 'Hertz. ×˜×•×™×•×˜×” RAV4. ×œ×‘×“×•×§ ×¦××™×’×™×.', cost: 0, booked: true, info: 'Voucher #555', distance: '×‘×©×“×” ×”×ª×¢×•×¤×”', warning: '×œ×¦×œ× ××ª ×”×¨×›×‘ ×œ×¤× ×™ ×”× ×¡×™×¢×”', type: 'car' },
                        { time: '19:30', title: '×¡×•×¤×¨××¨×§×˜ REMA 1000', desc: '×§× ×™×•×ª ×œ×™×•××™×™× ×¨××©×•× ×™×. ××™×, ×œ×—×, ×’×‘×™× ×•×ª.', cost: 600, booked: false, info: '', distance: '5 ×“×§×•×ª ××”×©×“×”', warning: '', type: 'market' },
                        { time: '20:30', title: '×¦\'×§ ××™×Ÿ Airbnb', desc: 'Ersfjordbotn. ×‘×§×ª×” ×¢×œ ×”××™×.', cost: 0, booked: true, info: '×§×•×“ ×œ×›×¡×¤×ª: 1234', distance: '15 ×“×§×•×ª ××”×¡×•×¤×¨', warning: '', type: 'home' }
                    ]
                },
                { 
                    id: 2, date: '14/1 (×“\')', title: '×”×¢×™×¨ ×˜×¨×•××¡×•', note: '×œ×”×ª×œ×‘×© ×©×›×‘×•×ª, ×§×¨ ×‘×¢×™×¨.',
                    timeline: [
                        { time: '10:00', title: '×—× ×™×” ×‘×× ×”×¨×”', desc: 'Fjellet P-hus. ×—× ×™×” ××—×•×××ª ×‘×ª×•×š ×”×”×¨.', cost: 120, booked: false, info: '', distance: '20 ×“×§×•×ª × ×¡×™×¢×”', warning: '×œ×”×•×¨×™×“ ××¤×œ×™×§×¦×™×™×ª EasyPark', type: 'car' },
                        { time: '11:30', title: '×¨×›×‘×œ Fjellheisen', desc: '×ª×¦×¤×™×ª ×¢×œ ×”×¢×™×¨. ×©×¢×ª ×“××“×•××™×.', cost: 260, booked: false, info: '', distance: '×œ×—×¦×•×ª ××ª ×”×’×©×¨', warning: '×× ××¢×•× ×Ÿ - ×œ×•×•×ª×¨', type: 'attraction' },
                        { time: '14:00', title: '××¡×¢×“×ª Rakettkiosken', desc: '×”× ×§× ×™×§×™×™×” ×”××¤×•×¨×¡××ª ×‘×›×™×›×¨.', cost: 80, booked: false, info: '', distance: '××¨×›×– ×”×¢×™×¨', warning: '', type: 'food' },
                        { time: '20:00', title: '×¦×™×“ ×–×•×”×¨ ×¢×¦×××™', desc: '× ×¡×™×¢×” ×œ-Ersfjordbotn ××• GrÃ¸tfjord.', cost: 0, booked: false, info: '', distance: '30-50 ×§"×', warning: '×œ×‘×“×•×§ ×ª×—×–×™×ª ×¢× × ×™× ×‘-Yr.no', type: 'star' }
                    ] 
                },
                { id: 3, date: '15/1 (×”\')', title: '×›×œ×‘×™× ×•×˜×‘×¢', note: '', timeline: [] },
                { id: 4, date: '16/1 (×•\')', title: '×”××¢×‘×•×¨×ª ×œ×¡× ×™×”', note: '', timeline: [] },
                { id: 5, date: '17/1 (×©\')', title: '×”××™ ×¡× ×™×”', note: '', timeline: [] },
                { id: 6, date: '18/1 (×\')', title: '×—×–×¨×” ×œ×˜×¨×•××¡×•', note: '', timeline: [] },
                { id: 7, date: '19/1 (×‘\')', title: '×™×•× ××—×¨×•×Ÿ', note: '', timeline: [] },
                { id: 8, date: '20/1 (×’\')', title: '×˜×™×¡×” ×”×‘×™×ª×”', note: '', timeline: [] }
            ],
            logistics: {
                flights: [{ id: 'f1', title: '×˜×™×¡×•×ª ×”×œ×•×š ×—×–×•×¨', options: [{id:'o1', name:'SAS Basic', cost:3500, booked:true}], selectedId: 'o1' }],
                housing: [{ id: 'h1', title: '×œ×™× ×” ×˜×¨×•××¡×•', options: [{id:'o1', name:'Airbnb Ersfjord', cost:3200, booked:true}], selectedId: 'o1' }],
                cars: [{ id: 'c1', title: '×¨×›×‘', options: [{id:'o1', name:'Toyota RAV4', cost:4500, booked:true}], selectedId: 'o1' }],
                markets: [{ id: 'm1', title: '×¡×•×¤×¨', options: [{id:'o1', name:'REMA 1000', cost:800, booked:false}], selectedId: 'o1' }]
            },
            checklist: [
                { id: 1, text: '×‘×™×’×•×“ ×ª×¨××™', source: '×“×§×˜×œ×•×Ÿ', cost: 400, gotIt: true },
                { id: 2, text: '×§×¨××¤×•× ×™×', source: '×××–×•×Ÿ', cost: 100, gotIt: false }
            ]
        };

        let isEditMode = false;
        let currentCurrency = 'ILS';
        let currentOpenDayIndex = -1;
        const EUR_RATE = 4;
        const CACHE_KEY = 'tromso_app_v4_cache';

        // --- HELPERS ---
        const formatPrice = (ils) => currentCurrency === 'ILS' ? `â‚ª${parseInt(ils||0).toLocaleString()}` : `â‚¬${(parseInt(ils||0)/EUR_RATE).toFixed(0)}`;
        
        // --- UI LOGIC ---
        window.toggleEditMode = () => {
            isEditMode = !isEditMode;
            document.body.classList.toggle('editing', isEditMode);
            document.getElementById('edit-btn').innerHTML = isEditMode ? 'âœ… ×¡×™×•×' : 'âœï¸ ×¢×¨×™×›×”';
            document.getElementById('edit-btn').classList.toggle('bg-green-100', isEditMode);
            renderAll(); // Re-render to update view states
        };

        window.toggleCurrency = () => {
            currentCurrency = currentCurrency === 'ILS' ? 'EUR' : 'ILS';
            document.getElementById('currency-btn').innerHTML = currentCurrency === 'ILS' ? '<b>â‚ª</b> | â‚¬' : 'â‚ª | <b>â‚¬</b>';
            renderAll();
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        };

        // --- RENDERERS ---

        // 1. GRID (Summary)
        function renderGrid() {
            const container = document.getElementById('days-grid');
            container.innerHTML = '';
            appData.days.forEach((day, idx) => {
                let totalCost = 0;
                day.timeline.forEach(t => totalCost += parseInt(t.cost || 0));
                
                const card = document.createElement('div');
                card.className = 'day-card';
                card.onclick = () => openDayModal(idx);
                card.innerHTML = `
                    <div>
                        <div class="text-xs font-bold text-indigo-500 uppercase mb-1">${day.date}</div>
                        <h3 class="text-xl font-bold text-gray-800 leading-tight mb-2">${day.title}</h3>
                        <p class="text-sm text-gray-500 line-clamp-3">${day.note || '××™×Ÿ ×”×¢×¨×•×ª'}</p>
                    </div>
                    <div class="border-t pt-3 flex justify-between items-center">
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">${day.timeline.length} ×¤×¢×™×œ×•×™×•×ª</span>
                        <span class="font-bold text-indigo-600">${formatPrice(totalCost)}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 2. DAY MODAL (Detail View)
        window.openDayModal = (idx) => {
            currentOpenDayIndex = idx;
            const day = appData.days[idx];
            
            // Set Header Data
            document.getElementById('view-day-title').textContent = day.title;
            document.getElementById('view-day-date').textContent = day.date;
            document.getElementById('modal-day-title').value = day.title;
            document.getElementById('modal-day-date').value = day.date;
            document.getElementById('modal-day-note').value = day.note || '';
            
            // Calc Total
            let total = 0;
            day.timeline.forEach(t => total += parseInt(t.cost || 0));
            document.getElementById('modal-day-cost').textContent = formatPrice(total);

            renderModalTimeline();
            document.getElementById('day-modal').style.display = 'flex';
        };

        window.closeDayModal = () => {
            document.getElementById('day-modal').style.display = 'none';
            currentOpenDayIndex = -1;
        };

        window.saveModalData = () => {
            if(currentOpenDayIndex === -1) return;
            const day = appData.days[currentOpenDayIndex];
            day.title = document.getElementById('modal-day-title').value;
            day.date = document.getElementById('modal-day-date').value;
            day.note = document.getElementById('modal-day-note').value;
            saveData();
            renderGrid(); // Update grid preview
        };

        function renderModalTimeline() {
            const container = document.getElementById('modal-timeline-container');
            container.innerHTML = '';
            const day = appData.days[currentOpenDayIndex];

            day.timeline.forEach((item, tIdx) => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                // Icon based on type
                let icon = 'ğŸ“';
                if(item.type === 'flight') icon = 'âœˆï¸';
                if(item.type === 'car') icon = 'ğŸš—';
                if(item.type === 'food') icon = 'ğŸ”';
                if(item.type === 'home') icon = 'ğŸ ';
                if(item.type === 'star') icon = 'âœ¨';

                const bookedBadge = item.booked ? 
                    `<span class="chip bg-green-100 text-green-800 border-green-200">âœ”ï¸ ×”×•×–××Ÿ</span>` : '';

                // HTML Construction
                div.innerHTML = `
                    <div class="timeline-icon">${icon}</div>
                    
                    <!-- VIEW MODE -->
                    <div class="view-only">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-lg font-bold text-indigo-900 w-14">${item.time}</span>
                            <h4 class="text-lg font-bold text-gray-800">${item.title}</h4>
                        </div>
                        <p class="text-gray-600 mb-2 text-sm leading-relaxed">${item.desc}</p>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${item.cost > 0 ? `<span class="chip chip-price">${formatPrice(item.cost)}</span>` : ''}
                            ${item.distance ? `<span class="chip chip-dist">ğŸš— ${item.distance}</span>` : ''}
                            ${bookedBadge}
                        </div>

                        ${item.warning ? `<div class="text-xs bg-red-50 border border-red-100 text-red-700 p-2 rounded mb-2">âš ï¸ ${item.warning}</div>` : ''}
                        ${item.info ? `<div class="text-xs bg-blue-50 border border-blue-100 text-blue-700 p-2 rounded">â„¹ï¸ ${item.info}</div>` : ''}
                    </div>

                    <!-- EDIT MODE -->
                    <div class="edit-only bg-white border border-gray-200 p-4 rounded-xl shadow-sm space-y-3">
                        <div class="flex gap-2">
                            <input type="time" value="${item.time}" class="w-24 font-bold" onchange="updateTimelineItem(${tIdx}, 'time', this.value)">
                            <input type="text" value="${item.title}" class="font-bold flex-1" placeholder="×›×•×ª×¨×ª ×¤×¢×™×œ×•×ª" onchange="updateTimelineItem(${tIdx}, 'title', this.value)">
                            <select class="w-10" onchange="updateTimelineItem(${tIdx}, 'type', this.value)">
                                <option value="place" ${item.type==='place'?'selected':''}>ğŸ“</option>
                                <option value="flight" ${item.type==='flight'?'selected':''}>âœˆï¸</option>
                                <option value="car" ${item.type==='car'?'selected':''}>ğŸš—</option>
                                <option value="food" ${item.type==='food'?'selected':''}>ğŸ”</option>
                                <option value="home" ${item.type==='home'?'selected':''}>ğŸ </option>
                            </select>
                        </div>
                        <textarea rows="2" class="text-sm" placeholder="×ª×™××•×¨" onchange="updateTimelineItem(${tIdx}, 'desc', this.value)">${item.desc}</textarea>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" value="${item.cost}" placeholder="×¢×œ×•×ª" class="text-sm" onchange="updateTimelineItem(${tIdx}, 'cost', this.value)">
                            <input type="text" value="${item.distance}" placeholder="××¨×—×§/×–××Ÿ × ×¡×™×¢×”" class="text-sm" onchange="updateTimelineItem(${tIdx}, 'distance', this.value)">
                        </div>
                        
                        <input type="text" value="${item.warning}" placeholder="âš ï¸ ××–×”×¨×•×ª/×“×’×©×™×" class="text-sm text-red-500 border-red-200 placeholder-red-200" onchange="updateTimelineItem(${tIdx}, 'warning', this.value)">
                        
                        <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border">
                            <input type="checkbox" class="w-4 h-4" ${item.booked ? 'checked' : ''} onchange="updateTimelineItem(${tIdx}, 'booked', this.checked)">
                            <span class="text-sm font-bold">×”×•×–××Ÿ?</span>
                            <input type="text" value="${item.info}" placeholder="×¤×¨×˜×™ ×”×–×× ×” (××¡×¤×¨ ××™×©×•×¨, ×œ×™× ×§)" class="flex-1 text-sm" onchange="updateTimelineItem(${tIdx}, 'info', this.value)">
                        </div>

                        <button class="text-red-500 text-xs underline" onclick="deleteTimelineItem(${tIdx})">××—×§ ×¤×¢×™×œ×•×ª</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.updateTimelineItem = (tIdx, field, val) => {
            appData.days[currentOpenDayIndex].timeline[tIdx][field] = val;
            saveData();
            
            // If cost changed, update header total
            if(field === 'cost') {
                let total = 0;
                appData.days[currentOpenDayIndex].timeline.forEach(t => total += parseInt(t.cost || 0));
                document.getElementById('modal-day-cost').textContent = formatPrice(total);
                renderGrid(); // update dashboard total
            }
        };

        window.addTimelineItemToModal = () => {
            appData.days[currentOpenDayIndex].timeline.push({time:'12:00', title:'×¤×¢×™×œ×•×ª ×—×“×©×”', desc:'', cost:0, booked:false, type:'place'});
            saveData();
            renderModalTimeline();
        };

        window.deleteTimelineItem = (tIdx) => {
            if(confirm('×œ××—×•×§?')) {
                appData.days[currentOpenDayIndex].timeline.splice(tIdx, 1);
                saveData();
                renderModalTimeline();
            }
        };
        
        window.deleteCurrentDay = () => {
            if(confirm('×œ××—×•×§ ××ª ×›×œ ×”×™×•× ×”×–×”?')) {
                appData.days.splice(currentOpenDayIndex, 1);
                saveData();
                closeDayModal();
                renderGrid();
            }
        }
        
        window.addDay = () => {
            appData.days.push({id: Date.now(), date: '×ª××¨×™×š', title: '×™×•× ×—×“×©', note: '', timeline: []});
            saveData();
            renderGrid();
        }

        // 3. LOGISTICS (Generic)
        function renderLogisticsGroup(type, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const groups = appData.logistics[type] || [];

            groups.forEach((group, gIdx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-white border border-gray-200 rounded-xl p-4 mb-3';
                
                // Group Header
                let header = `
                    <div class="flex justify-between items-center mb-2">
                        <input class="font-bold text-lg bg-transparent edit-only w-full" value="${group.title}" onchange="updateGroup('${type}', ${gIdx}, 'title', this.value)">
                        <h3 class="font-bold text-gray-800 view-only">${group.title}</h3>
                        <button class="edit-only text-red-400 text-sm" onclick="deleteGroup('${type}', ${gIdx})">ğŸ—‘ï¸</button>
                    </div>
                `;

                let optionsHtml = '';
                group.options.forEach((opt, oIdx) => {
                    const isSelected = group.selectedId === opt.id;
                    
                    // Edit Mode
                    if (isEditMode) {
                        optionsHtml += `
                            <div class="option-card ${isSelected ? 'selected' : ''} p-3 relative mb-2">
                                <div class="flex gap-2 items-center mb-2">
                                    <input type="radio" name="grp-${type}-${gIdx}" ${isSelected ? 'checked' : ''} onchange="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                    <input class="font-bold text-sm flex-1" value="${opt.name}" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'name', this.value)">
                                    <button class="text-red-400 text-xs" onclick="deleteOption('${type}', ${gIdx}, ${oIdx})">x</button>
                                </div>
                                <input type="number" class="w-full text-xs mb-1 p-1 border rounded" value="${opt.cost}" placeholder="××—×™×¨" onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'cost', this.value)">
                                <div class="flex gap-2 items-center bg-gray-50 p-1 rounded">
                                    <input type="checkbox" ${opt.booked ? 'checked' : ''} onchange="updateOption('${type}', ${gIdx}, ${oIdx}, 'booked', this.checked)">
                                    <span class="text-xs">×”×•×–××Ÿ</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // View Mode (Only show selected unless there are alternatives to swap)
                        optionsHtml += `
                            <div class="option-card ${isSelected ? 'selected' : ''} flex justify-between items-center p-3 mb-2 cursor-pointer hover:bg-gray-50" onclick="selectOption('${type}', ${gIdx}, '${opt.id}')">
                                <div>
                                    <div class="font-bold text-sm flex items-center gap-2">
                                        ${opt.name} 
                                        ${opt.booked ? '<span class="badge-booked">×”×•×–××Ÿ</span>' : ''}
                                        ${isSelected ? '<span class="text-indigo-600 text-xs border border-indigo-200 px-1 rounded">× ×‘×—×¨</span>' : ''}
                                    </div>
                                    <div class="text-xs text-gray-500">×œ×—×¥ ×œ×”×—×œ×¤×”</div>
                                </div>
                                <div class="font-bold text-indigo-700">${formatPrice(opt.cost)}</div>
                            </div>
                        `;
                    }
                });

                wrapper.innerHTML = header + optionsHtml + (isEditMode ? `<button class="w-full text-xs border border-dashed p-1 mt-1 text-gray-400" onclick="addOption('${type}', ${gIdx})">+ ××•×¤×¦×™×”</button>` : '');
                container.appendChild(wrapper);
            });
        }

        // Wrapper functions for logistics
        window.updateGroup = (t, i, f, v) => { appData.logistics[t][i][f] = v; saveData(); };
        window.deleteGroup = (t, i) => { if(confirm('×œ××—×•×§?')) { appData.logistics[t].splice(i,1); saveData(); renderAll(); } };
        window.addGroup = (t) => { if(!appData.logistics[t]) appData.logistics[t]=[]; appData.logistics[t].push({id:Date.now(), title:'×—×“×©', options:[{id:'o'+Date.now(), name:'××•×¤×¦×™×” 1', cost:0}], selectedId:'o'+Date.now()}); saveData(); renderAll(); };
        
        window.updateOption = (t, g, o, f, v) => { appData.logistics[t][g].options[o][f] = v; saveData(); renderAll(); };
        window.selectOption = (t, g, id) => { appData.logistics[t][g].selectedId = id; saveData(); renderAll(); };
        window.addOption = (t, g) => { appData.logistics[t][g].options.push({id:'o'+Date.now(), name:'×—×“×©', cost:0}); saveData(); renderAll(); };
        window.deleteOption = (t, g, o) => { appData.logistics[t][g].options.splice(o,1); saveData(); renderAll(); };

        // 4. CHECKLIST
        function renderChecklist() {
            const tbody = document.getElementById('checklist-table-body');
            tbody.innerHTML = '';
            appData.checklist.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-2 py-3"><input type="checkbox" ${item.gotIt ? 'checked' : ''} onchange="updateChecklist(${idx}, 'gotIt', this.checked)"></td>
                    <td class="px-2 py-3"><span class="view-only ${item.gotIt ? 'line-through text-gray-400' : ''}">${item.text}</span><input class="edit-only" value="${item.text}" onchange="updateChecklist(${idx}, 'text', this.value)"></td>
                    <td class="px-2 py-3 text-xs"><span class="view-only">${item.source||'-'}</span><input class="edit-only" value="${item.source||''}" onchange="updateChecklist(${idx}, 'source', this.value)"></td>
                    <td class="px-2 py-3 font-bold text-indigo-600"><span class="view-only">${formatPrice(item.cost)}</span><input type="number" class="edit-only w-20" value="${item.cost}" onchange="updateChecklist(${idx}, 'cost', this.value)"></td>
                    <td class="px-2 py-3 edit-only"><button class="text-red-400" onclick="deleteChecklist(${idx})">ğŸ—‘ï¸</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        window.updateChecklist = (i,f,v) => { appData.checklist[i][f]=v; saveData(); renderAll(); };
        window.deleteChecklist = (i) => { appData.checklist.splice(i,1); saveData(); renderAll(); };
        window.addCheckItem = () => { 
            appData.checklist.push({id:Date.now(), text: document.getElementById('new-item-text').value, source: document.getElementById('new-item-source').value, cost: document.getElementById('new-item-price').value, gotIt: false}); 
            saveData(); renderAll(); 
        };

        // 5. BUDGET
        function renderBudget() {
            let paid = 0, future = 0;
            
            const sum = (c, b) => b ? paid += parseInt(c||0) : future += parseInt(c||0);

            appData.days.forEach(d => d.timeline.forEach(t => sum(t.cost, t.booked)));
            ['flights','housing','cars','markets'].forEach(t => (appData.logistics[t]||[]).forEach(g => {
                const s = g.options.find(o => o.id === g.selectedId);
                if(s) sum(s.cost, s.booked);
            }));
            appData.checklist.forEach(c => sum(c.cost, c.gotIt));

            document.getElementById('total-paid').textContent = formatPrice(paid);
            document.getElementById('total-future').textContent = formatPrice(future);
            document.getElementById('total-sum').textContent = formatPrice(paid+future);

            const ctx = document.getElementById('budgetChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['×©×•×œ×','×¢×ª×™×“×™'], datasets: [{ data: [paid, future], backgroundColor: ['#16A34A','#E5E7EB'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false } });
        }

        // --- CORE ---
        async function saveData() {
            updateSyncStatus('×©×•××¨...', 'yellow');
            try { await updateDoc(tripRef, appData); localStorage.setItem(CACHE_KEY, JSON.stringify(appData)); updateSyncStatus('××¡×•× ×›×¨×Ÿ', 'green'); } catch(e) { console.error(e); }
        }

        function updateSyncStatus(t, c) {
            document.getElementById('sync-text').textContent = t;
            document.getElementById('sync-dot').className = `w-2 h-2 rounded-full bg-${c}-500`;
        }

        window.renderAll = () => {
            renderGrid();
            renderLogisticsGroup('flights', 'flights-container');
            renderLogisticsGroup('housing', 'housing-container');
            renderLogisticsGroup('cars', 'cars-container');
            renderLogisticsGroup('markets', 'markets-container');
            renderChecklist();
            renderBudget();
        }

        // Auth & Cache
        if (localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            const cached = localStorage.getItem(CACHE_KEY);
            if(cached) { appData = JSON.parse(cached); renderAll(); }
            onSnapshot(tripRef, (s) => {
                document.getElementById('loading-screen').style.display = 'none';
                if(s.exists()) { 
                    appData = s.data(); 
                    if(!appData.logistics) appData.logistics = {flights:[],housing:[],cars:[],markets:[]}; // integrity check
                    localStorage.setItem(CACHE_KEY, JSON.stringify(appData)); renderAll(); updateSyncStatus('××¡×•× ×›×¨×Ÿ', 'green');
                } else { setDoc(tripRef, appData); }
            });
        } else {
            document.getElementById('loading-screen').style.display = 'none';
        }

        document.getElementById('login-btn').onclick = () => {
            if(document.getElementById('passcode-input').value === '8989') {
                localStorage.setItem('isLoggedIn', 'true');
                // Instant switch to prevent reload loop
                document.getElementById('login-screen').style.display = 'none';
                onSnapshot(tripRef, (s) => {
                    if(s.exists()) appData = s.data();
                    else setDoc(tripRef, appData);
                    renderAll();
                });
            } else document.getElementById('login-error').classList.remove('hidden');
        };

    </script>
</body>
</html>
